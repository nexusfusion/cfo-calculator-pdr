# 5.4 Retention Policies (Cross-Calculator)

This section defines data retention rules for scenarios, telemetry, logs, and exports. Retention policies balance user convenience (long-term access to saved data) with data minimization (GDPR/CCPA compliance, reduced liability, lower storage costs). All retention periods can be overridden by B2B tenants with stricter requirements.

---

## 1. Scenario Data Retention

### Anonymous Scenarios

**Definition**: Scenarios created by anonymous users (no account, session ID only).

**Retention period**: **24 hours**

**Rationale**:
- Anonymous users have no persistent identity (session expires after 30 days of inactivity)
- Scenarios stored temporarily for UX (user can refresh page and continue working)
- No expectation of long-term storage (user not logged in)

**Deletion process**:
- **Automatic purge**: Nightly cron job deletes scenarios where `created_at < NOW() - INTERVAL '24 hours'` AND `user_id IS NULL`
- **Hard delete**: Scenario record and associated data (inputs, outputs, warnings) removed from database

**User notification**: None (transient data, no account to notify)

---

### Saved Scenarios (Registered Users)

**Definition**: Scenarios created by logged-in users (saved to account).

**Retention period**: **24 months** (default, user-configurable)

**Rationale**:
- Users may want to compare scenarios across multiple quarters/years (e.g., Q1 2025 vs Q1 2024 assumptions)
- 24 months allows annual comparisons plus buffer
- Balances user convenience with data minimization (GDPR encourages limiting retention)

**Activity-based extension**:
- If scenario is **accessed** (viewed, edited, exported) within 24 months, retention extends from last access date
- Example: Scenario created Jan 2025, accessed Dec 2026 → retention extends to Dec 2028

**Deletion process**:
- **Automated purging**: Nightly cron job deletes scenarios where `accessed_at < NOW() - INTERVAL '24 months'`
- **User notification (optional)**: Email 30 days before purge: "Your scenario '[Scenario Name]' will be deleted on [Date]. Access it to extend retention."
- **Hard delete**: Scenario record removed from database

**User-initiated deletion**:
- User can delete scenarios anytime via UI ("Delete Scenario" button)
- **Immediate hard delete**: No soft delete, no recovery period (user confirmation required)

---

### Deleted Scenarios (Soft Delete, Optional)

**Phase 2+ feature** (not implemented in Phase 1):
- Scenarios marked as `deleted_at` timestamp (soft delete)
- Retained for 30 days (recovery period: user can "undo delete")
- After 30 days, hard delete (nightly purge job)

**Rationale**: Prevents accidental deletion regret ("I deleted the wrong scenario!"), but adds complexity (not prioritized for Phase 1)

---

## 2. Telemetry and Log Retention

### Analytics Events

**Definition**: Usage events (calculations, exports, tier upgrades, feature adoption) stored for Business Intelligence Dashboard (Section 1.8).

**Retention period**: **12 months** (raw events), **indefinite** (aggregated summaries)

**Rationale**:
- 12 months provides sufficient data for cohort analysis, conversion funnels, feature adoption trends
- Beyond 12 months, aggregated summaries suffice (daily/monthly rollups retain insights without raw event storage)

**Aggregation process**:
- **Daily rollups**: Nightly cron job aggregates previous day's events (e.g., "1,234 calculations on 2025-01-15 for business-loan calculator")
- **Monthly rollups**: Monthly cron job aggregates month's events (e.g., "45,678 calculations in Jan 2025, 3.2% Free → Pro conversion")
- **Aggregated data stored indefinitely** (no PII, just counts and percentages)

**Deletion process**:
- **Raw events**: After 12 months, nightly purge job drops old partitions (e.g., `DROP TABLE events_2024_01` in Feb 2025)
- **Aggregated summaries**: Never deleted (unless business no longer needs historical trends)

**PII exclusion** (per Section 5.2.3):
- Events use pseudonymous `user_id` and `session_id` (not email or name)
- IP addresses hashed before logging (not reversible)

---

### Error Logs

**Definition**: Application errors, exceptions, stack traces logged for debugging and monitoring.

**Retention period**:
- **Detailed logs**: **30 days**
- **Aggregated error counts**: **12 months**

**Rationale**:
- 30 days provides sufficient time to debug recent issues
- Aggregated counts (error rate trends) useful for monitoring long-term stability

**Deletion process**:
- **Detailed logs**: Rolling 30-day window (e.g., Sentry, Datadog auto-purges logs older than 30 days)
- **Aggregated counts**: Stored in analytics database, purged after 12 months

**PII exclusion**:
- Email addresses scrubbed from logs (replaced with `user_id`)
- IP addresses hashed (not logged in plaintext)
- Scenario inputs redacted (only log metadata: calculator ID, input hash, not actual values)

---

### AI Request Logs

**Definition**: Logs of AI requests (prompts, responses, costs) for quality monitoring and abuse detection.

**Retention period**: **12 months** (redacted, no user content)

**Rationale**:
- 12 months allows quality analysis (which prompts produce good results, which fail)
- Cost tracking (LLM API costs per user, per calculator)
- Abuse detection (excessive AI usage, prompt injection attempts)

**Redaction**:
- **DO NOT LOG**: User's scenario inputs/outputs (PII risk, privacy violation)
- **DO LOG**: Pseudonymous user ID, calculator ID, request timestamp, response time, LLM cost, error codes

**Example log entry**:
```json
{
  "request_id": "uuid-1234",
  "user_id": "uuid-5678",
  "calculator_id": "business-loan",
  "timestamp": "2025-01-15T14:30:00Z",
  "prompt_template": "dscr_explanation_v1",
  "response_time_ms": 2340,
  "llm_provider": "openai",
  "llm_model": "gpt-4",
  "llm_cost_usd": 0.012,
  "success": true,
  "error_code": null
}
```

**Deletion process**: Purge after 12 months (nightly cron job)

---

### Audit Logs (Admin Actions)

**Definition**: Logs of admin actions (user impersonation, tenant config changes, scenario deletions).

**Retention period**: **24 months**

**Rationale**:
- Longer retention for compliance and security investigations
- Audit trail for "Who deleted this tenant's data?" or "Who accessed this user's account?"

**What's logged**:
- Admin user ID, action type (e.g., "impersonate_user", "delete_scenario", "update_tenant_config")
- Target user/tenant ID, timestamp, IP address (hashed), user agent

**Deletion process**: Purge after 24 months (unless legal hold requires longer retention)

---

## 3. Export File Retention

### Anonymous Exports

**Definition**: Exports generated by anonymous users (no account).

**Retention period**: **24 hours**

**Rationale**:
- Anonymous users have no persistent identity (cannot retrieve export after session expires)
- Temporary storage for immediate download only
- Reduces storage costs (exports are large files: PDFs 100KB-1MB, Excel multi-MB)

**Deletion process**:
- **Automatic purge**: Nightly cron job deletes exports where `created_at < NOW() - INTERVAL '24 hours'` AND `user_id IS NULL`
- **Hard delete**: S3/R2 file deleted, database record removed

**Download behavior**:
- User receives presigned URL (valid for 1 hour) immediately after export generation
- If user doesn't download within 24 hours, export is lost (must regenerate)

---

### Saved Exports (Registered Users)

**Definition**: Exports generated by logged-in users.

**Retention period**: **90 days**

**Rationale**:
- 90 days allows users to retrieve exports from recent quarters (e.g., Q1 board deck exported in March, retrieved in June)
- Balance user convenience with storage costs

**Download link expiration**: **7 days** (presigned URL expires after 7 days, but file remains stored for 90 days)

**Re-download process**:
- If download link expires, user can request new presigned URL from account dashboard ("Re-download export")
- No new export generated (retrieves existing file from S3/R2)

**Deletion process**:
- **Soft delete** (optional): After 90 days, mark export as `deleted_at`, retain for 30 days (recovery period)
- **Hard delete**: After 120 days (90 + 30 grace), delete S3/R2 file and database record

**User-initiated deletion**:
- User can delete exports anytime via account dashboard
- Immediate hard delete (S3/R2 file and database record removed)

---

### Download Link Expiration (All Tiers)

**Presigned URL expiry**: **7 days** after export generation

**Rationale**:
- Presigned URLs are publicly accessible (no authentication required)
- Short expiry limits risk of URL leakage (if user shares link, it expires quickly)

**Re-download process** (for logged-in users):
1. User navigates to "Exports" page in account dashboard
2. Clicks "Download" on expired export
3. System generates new presigned URL (valid for 1 hour)
4. User downloads file

**For anonymous users**: No re-download (export deleted after 24 hours)

---

## 4. Per-Tenant Overrides (B2B)

B2B tenants may have stricter retention requirements due to regulatory or internal policy constraints.

### Tenant Config for Custom Retention

**Configurable retention periods** (per Section 5.1.3):
```json
{
  "tenant_id": "uuid-1234",
  "retention_policy": {
    "scenarios_days": 365,        // Shorter than default 730 (24 months)
    "exports_days": 30,            // Shorter than default 90
    "logs_days": 180,              // Shorter than default 365
    "telemetry_enabled": false     // Opt-out of telemetry (no events logged)
  }
}
```

**Shorter periods allowed**: Tenants can reduce retention (e.g., 30 days instead of 90 days for exports)

**Longer periods NOT allowed** (by default): Extending retention beyond defaults requires legal review (GDPR data minimization principle)

---

### Stricter Retention for Regulated Customers

**Example**: Tenant is a credit union (subject to NCUA regulations, requires 5-year audit trail).

**Custom retention**:
```json
{
  "retention_policy": {
    "scenarios_days": 1825,        // 5 years (regulatory requirement)
    "exports_days": 1825,
    "logs_days": 1825,
    "audit_logs_days": 2555        // 7 years (tax/legal requirement)
  }
}
```

**Legal review required**: Any retention > 24 months requires legal approval (GDPR/CCPA allow longer retention for legal/regulatory reasons, but must be documented)

---

### Data Residency Requirements

**Example**: EU tenant requires data stored in EU region (GDPR Schrems II compliance).

**Implementation** (Phase 3+ feature):
- Tenant config includes `data_region` field: `"eu-west-1"`
- Database and S3/R2 storage replicated to EU region
- Application servers route tenant requests to EU region

**Phase 1 limitation**: All data stored in US (no multi-region support)

**Workaround for EU tenants** (Phase 1):
- Self-hosted deployment (Docker/Kubernetes images deployed to tenant's infrastructure)
- Tenant manages data residency (no data leaves their region)

---

### Opt-Out of Telemetry

**B2B tenants can disable telemetry** (per Section 5.1.3):
```json
{
  "retention_policy": {
    "telemetry_enabled": false     // No analytics events logged
  }
}
```

**Impact**:
- No usage analytics (tenant loses Business Intelligence Dashboard visibility)
- No conversion funnel tracking (cannot see Free → Pro conversion for tenant users)
- No feature adoption metrics

**Rationale**: Some tenants (e.g., government contractors, highly regulated industries) cannot share usage data due to policy constraints

---

## Retention Policy Summary Table

| Data Type | Anonymous Users | Registered Users (Free/Pro) | B2B Tenant (Default) | B2B Tenant (Configurable) |
|-----------|----------------|----------------------------|---------------------|---------------------------|
| **Scenarios** | 24 hours | 24 months (activity-based extension) | 24 months | 30 days - 7 years |
| **Exports** | 24 hours | 90 days | 90 days | 7 days - 7 years |
| **Analytics events (raw)** | 12 months | 12 months | 12 months | 0 (opt-out) - 12 months |
| **Analytics aggregates** | Indefinite | Indefinite | Indefinite | Indefinite (or opt-out) |
| **Error logs (detailed)** | 30 days | 30 days | 30 days | 7 days - 90 days |
| **Error logs (aggregated)** | 12 months | 12 months | 12 months | 12 months |
| **AI request logs** | 12 months | 12 months | 12 months | 0 (opt-out) - 12 months |
| **Audit logs (admin actions)** | N/A | N/A | 24 months | 24 months - 7 years |

---

## Automated Retention Enforcement

### Nightly Purge Jobs

**Cron schedule**: Daily at 2:00 AM UTC (low-traffic period)

**Purge jobs**:
1. **Scenarios**: Delete scenarios where `accessed_at < NOW() - retention_period` (per tier/tenant config)
2. **Exports**: Delete export files (S3/R2) and database records where `created_at < NOW() - retention_period`
3. **Events**: Drop old event table partitions (e.g., `DROP TABLE events_2024_01` after 12 months)
4. **Logs**: Truncate old log entries (via Sentry, Datadog auto-purge, or custom SQL `DELETE`)

**Monitoring**:
- Alert if purge job fails (e.g., database connection error, S3 API failure)
- Metrics: "Purged 1,234 scenarios, 567 exports, 89,012 events on 2025-01-15"

---

### User Notifications (Optional)

**30-day warning email** (for scenario purges):
```
Subject: Your scenario "[Scenario Name]" will be deleted soon

Hi [User Name],

Your scenario "[Scenario Name]" in the [Calculator Name] calculator hasn't been
accessed in 23 months. It will be automatically deleted on [Date] per our 24-month
retention policy.

To keep this scenario, simply open it in the calculator:
[Link to scenario]

Questions? Contact support: support@example.com
```

**Rationale**: Prevents unintended data loss (user may have forgotten about old scenarios)

**Opt-out**: Users can disable "retention reminder" emails in account settings

---

## Summary

These retention policies ensure:
- **Data minimization**: Transient data (anonymous scenarios, exports) deleted quickly (24 hours)
- **User convenience**: Registered users retain scenarios and exports for reasonable periods (24 months, 90 days)
- **Compliance**: GDPR/CCPA-compliant retention (no indefinite storage, user-initiated deletion honored)
- **B2B flexibility**: Tenants can configure shorter retention (privacy) or longer retention (regulatory requirements)
- **Automated enforcement**: Nightly purge jobs ensure retention policies are applied consistently

All retention periods documented here are defaults; Section 11 calculator-specific PDRs may define exceptions (e.g., extended retention for audit-critical calculators).
