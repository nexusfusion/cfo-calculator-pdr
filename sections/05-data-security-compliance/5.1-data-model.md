# 5.1 Data Model (Suite-Level)

This section defines the core data models used across the CFO Business Intelligence Calculator Suite. These models are designed to support Free/Pro/AI tiering, B2B multi-tenancy, and compliance requirements (GDPR/CCPA data deletion, minimal PII exposure per Section 1.7).

---

## 1. User Model

### Anonymous Users

Anonymous users can use calculators without creating an account. They are tracked via session IDs for analytics and temporary scenario storage.

**Fields**:
```json
{
  "session_id": "uuid-v4",              // Primary key, pseudonymous identifier
  "created_at": "2025-01-15T14:30:00Z", // Session creation timestamp
  "last_seen": "2025-01-15T16:45:00Z",  // Last activity timestamp
  "browser_fingerprint": "hash",        // Optional: for abuse detection only
  "tier": "free",                       // Always "free" for anonymous
  "locale": "en-US"                     // User's locale (from Accept-Language header)
}
```

**Storage**:
- **Sessions table** (PostgreSQL) or Redis with 30-day TTL
- **Retention**: 30 days of inactivity → auto-delete session and associated scenarios

**Notes**:
- No PII (no email, no name)
- Session ID stored in httpOnly cookie (secure, not accessible via JavaScript)
- Browser fingerprint used only for rate limiting/abuse detection (hashed, not reversible)

---

### Registered Users

Registered users create accounts to save scenarios, access Pro tier features, and sync across devices.

**Fields**:
```json
{
  "user_id": "uuid-v4",                 // Primary key
  "email": "user@example.com",          // PII: only identifier tied to user
  "email_verified": true,               // Email verification status
  "password_hash": "bcrypt-hash",       // bcrypt or Argon2 hash (never plaintext)
  "tier": "pro",                        // "free", "pro", "ai", "b2b"
  "subscription_id": "stripe-sub-id",   // Stripe/payment provider subscription ID
  "signup_date": "2025-01-01T00:00:00Z",
  "last_login": "2025-01-15T14:30:00Z",
  "locale": "en-US",
  "timezone": "America/New_York",       // For export timestamps, email scheduling
  "tenant_id": null,                    // null for individual users, UUID for B2B
  "metadata": {
    "onboarding_completed": true,
    "feature_flags": {
      "beta_features": false
    }
  }
}
```

**Storage**:
- **Users table** (PostgreSQL)
- **Indexes**: `email` (unique), `tier`, `tenant_id`

**Notes**:
- Email is only PII field (per Section 1.7, no SSN, no financial account data)
- Password never stored in plaintext (bcrypt with cost factor 12 or Argon2)
- `metadata` field allows extensibility without schema changes

---

### B2B/Tenant Users

B2B users belong to an organization (tenant) and have roles within that organization.

**Fields** (extends Registered User model):
```json
{
  "user_id": "uuid-v4",
  "email": "analyst@corporation.com",
  "tier": "b2b",
  "tenant_id": "uuid-v4",               // Foreign key to tenants table
  "role_in_tenant": "user",             // "admin", "user", "viewer"
  "permissions": {
    "can_create_scenarios": true,
    "can_share_scenarios": true,
    "can_export": true,
    "can_use_ai": false                 // Tenant may disable AI for specific users
  },
  "created_by_admin": "uuid-v4"         // User ID of admin who created this account
}
```

**Roles**:
- **Admin**: Manage tenant settings, invite users, view all scenarios, configure branding
- **User**: Create scenarios, export, share (default role)
- **Viewer**: Read-only access to shared scenarios (cannot create or edit)

---

## 2. Scenario Model

### Core Fields

Scenarios are the primary user-generated data in the system. Each scenario represents one set of calculator inputs and outputs.

```json
{
  "scenario_id": "uuid-v4",             // Primary key
  "calculator_id": "business-loan",     // Which calculator this scenario belongs to
  "user_id": "uuid-v4",                 // Foreign key (null for anonymous users)
  "session_id": "uuid-v4",              // Foreign key (null for registered users)
  "tenant_id": null,                    // Foreign key to tenant (for B2B scenarios)
  "created_at": "2025-01-15T14:30:00Z",
  "updated_at": "2025-01-15T16:45:00Z",
  "accessed_at": "2025-01-20T10:00:00Z", // Last viewed (for retention policy)

  "name": "Base Case",                  // User-defined scenario name
  "description": "Conservative assumptions for lender presentation", // Optional
  "tags": ["lender", "conservative"],   // User-defined tags (for filtering)
  "is_baseline": true,                  // User can mark one scenario as baseline

  "inputs": { /* Calculator-specific JSON, see below */ },
  "outputs": { /* Calculated results JSON, see below */ },
  "warnings": [ /* Array of warning objects, see below */ ],

  "calculator_version": "1.2.0",        // Calculator UI version (for breaking changes)
  "formula_version": {                  // Formula versions used (for audit trail)
    "amortization": "1.3.2",
    "dscr": "1.1.0"
  }
}
```

**Storage**:
- **Scenarios table** (PostgreSQL)
- **Indexes**: `user_id`, `session_id`, `calculator_id`, `tenant_id`, `accessed_at` (for retention cleanup)
- **JSONB columns**: `inputs`, `outputs`, `warnings`, `formula_version` (queryable with GIN indexes)

---

### Input Data Structure (Calculator-Specific)

Inputs are stored as JSON, schema varies per calculator.

**Example: Business Loan Calculator**:
```json
{
  "principal": 200000,                  // Number (dollars)
  "annual_rate": 0.075,                 // Number (decimal, not percentage)
  "term_months": 60,                    // Integer
  "payment_frequency": "monthly",       // String enum
  "origination_fee": 2000,              // Number (dollars)
  "operating_income_monthly": 50000     // Number (dollars/month)
}
```

**Validation**:
- Server-side validation against JSON schema (defined in calculator config, Section 3.3)
- Type checking: numbers, strings, enums
- Range checking: `principal > 0`, `annual_rate >= 0 && annual_rate <= 0.5`

---

### Output Data Structure

Outputs are calculated results, stored for caching and audit trail.

**Example: Business Loan Calculator**:
```json
{
  "monthly_payment": 4000.00,           // Number (dollars)
  "total_interest": 40000.00,
  "total_cost": 240000.00,
  "dscr": 1.32,                         // Number (ratio)
  "covenant_headroom": 0.07,            // Number (ratio difference)
  "amortization_schedule": [
    {
      "month": 1,
      "payment": 4000.00,
      "principal": 2500.00,
      "interest": 1500.00,
      "balance": 197500.00
    }
    // ... 59 more months
  ],
  "calculated_at": "2025-01-15T14:30:05Z", // Timestamp of calculation
  "calculation_time_ms": 142            // Performance tracking
}
```

**Notes**:
- All currency values stored as numbers (not strings)
- Decimals stored with full precision (e.g., 1.32456789), formatted on display
- `calculated_at` timestamp allows recalculation detection (stale results)

---

### Warnings Array

Warnings are generated during calculation and stored with scenario.

```json
{
  "warnings": [
    {
      "severity": "warning",            // "info", "warning", "danger"
      "metric": "dscr",                 // Which metric triggered warning
      "message": "Your DSCR of 1.18 is below the typical lender threshold of 1.25. Consider reducing debt or improving cash flow.",
      "threshold": 1.25,                // Threshold value (for reference)
      "actual_value": 1.18,             // User's value
      "recommendation": "Consider reducing debt or improving cash flow."
    }
  ]
}
```

---

### Versioning

**Calculator version**:
- Tracks UI/feature version (e.g., `1.2.0`)
- Breaking changes (e.g., remove input field, change input semantics) bump major version
- Allows migration of old scenarios to new schema

**Formula version**:
- Tracks which formula versions were used (per Section 3.3)
- Stored in `formula_version` field as map: `{ "dscr": "1.1.0", "amortization": "1.3.2" }`
- Appears in exports for audit trail

---

## 3. Tenant/Organization Model (B2B)

B2B customers (lenders, advisors, SaaS platforms embedding calculators) are modeled as tenants.

### Tenant Config

```json
{
  "tenant_id": "uuid-v4",               // Primary key
  "name": "Acme Financial Advisors",    // Organization name
  "domain": "acmefinancial.com",        // Primary domain (for SSO, email validation)
  "status": "active",                   // "active", "suspended", "trial"
  "tier": "b2b",                        // Always "b2b"
  "plan": "enterprise",                 // "starter", "growth", "enterprise"

  "created_at": "2024-06-01T00:00:00Z",
  "trial_ends_at": null,                // null if not on trial
  "subscription_id": "stripe-sub-id",

  "feature_flags": {
    "ai_enabled": false,                // Tenant can disable AI entirely
    "white_label": true,                // Remove "Powered by" branding
    "custom_domain": "calculators.acmefinancial.com",
    "api_access": true,                 // Enable API keys for programmatic access
    "max_users": 25,                    // User seat limit
    "max_scenarios_per_user": 20        // Higher than default Pro tier (10)
  },

  "branding": {
    "logo_url": "https://cdn.acme.com/logo.png",
    "primary_color": "#0066CC",         // Hex color for buttons, links
    "footer_disclaimer": "Custom disclaimer text for exports"
  },

  "usage_limits": {
    "calculations_per_month": 100000,   // Tenant-wide limit
    "exports_per_month": 5000,
    "ai_requests_per_month": 0          // Disabled
  },

  "retention_policy": {
    "scenarios_days": 730,              // 2 years (default 24 months)
    "exports_days": 90,
    "logs_days": 365,
    "telemetry_enabled": false          // Opt-out of telemetry
  }
}
```

**Storage**:
- **Tenants table** (PostgreSQL)
- **Indexes**: `domain`, `status`

---

### User-to-Tenant Relationships

Many-to-one: Multiple users belong to one tenant.

**Foreign key**: `users.tenant_id` → `tenants.tenant_id`

**Role mapping** (stored in `users.role_in_tenant`):
- **admin**: Full access, can invite users, configure branding, view all scenarios
- **user**: Standard access, create scenarios, export, share
- **viewer**: Read-only, can view shared scenarios only

---

### Tenant-Level Usage Tracking

Aggregated usage tracked per tenant for billing and limit enforcement.

```json
{
  "tenant_id": "uuid-v4",
  "month": "2025-01",                   // YYYY-MM
  "calculations": 45230,                // Count of calculations this month
  "exports": 1203,
  "ai_requests": 0,
  "active_users": 18,                   // Unique users who logged in this month
  "scenarios_created": 456,
  "updated_at": "2025-01-20T10:00:00Z"  // Last update timestamp
}
```

**Storage**:
- **Tenant usage table** (PostgreSQL) or separate analytics database
- **Partitioned by month** for efficient queries and cleanup

---

## 4. Export Model

### Export Metadata

```json
{
  "export_id": "uuid-v4",               // Primary key
  "user_id": "uuid-v4",                 // Foreign key (null for anonymous)
  "session_id": "uuid-v4",              // Foreign key (null for registered users)
  "tenant_id": null,                    // Foreign key (for B2B exports)

  "scenario_ids": [                     // Array of scenario UUIDs (multi-scenario exports)
    "uuid-v4-1",
    "uuid-v4-2"
  ],
  "calculator_id": "business-loan",
  "format": "pdf",                      // "pdf", "csv", "excel"

  "created_at": "2025-01-15T14:30:00Z",
  "expires_at": "2025-01-22T14:30:00Z", // 7 days after creation (download link expiry)
  "deleted_at": null,                   // Soft delete timestamp (retention policy)

  "file_storage_key": "exports/2025-01/uuid-v4.pdf", // S3/R2 key
  "file_size_bytes": 245678,
  "download_count": 2,                  // Track how many times downloaded

  "generation_time_ms": 2450,           // Performance tracking
  "watermarked": true,                  // Free tier exports are watermarked

  "metadata": {
    "tier": "free",                     // Tier at time of export
    "formula_versions": {               // Audit trail
      "dscr": "1.1.0",
      "amortization": "1.3.2"
    }
  }
}
```

**Storage**:
- **Exports table** (PostgreSQL)
- **File storage**: S3/Cloudflare R2 (referenced by `file_storage_key`)
- **Indexes**: `user_id`, `session_id`, `expires_at` (for cleanup job), `deleted_at` (for soft delete filtering)

---

### File Storage References

**S3/R2 key structure**:
```
exports/
  {YYYY-MM}/
    {export_id}.pdf
    {export_id}.csv
    {export_id}.xlsx
```

**Presigned URL generation** (for download):
- Generate presigned URL with 1-hour expiry when user requests download
- URL format: `https://r2.smartprofit.com/exports/2025-01/uuid-v4.pdf?signature=...&expires=...`

---

### Expiration/Retention Rules

**Anonymous exports**:
- Created → 24 hours → auto-delete (hard delete from S3 and database)

**Registered user exports (Free tier)**:
- Created → 90 days → soft delete (mark `deleted_at`, hide from UI)
- Soft delete → 30 days → hard delete (remove from S3 and database)

**Registered user exports (Pro tier)**:
- Created → 90 days → soft delete
- Soft delete → 30 days → hard delete

**Download link expiry** (all tiers):
- Presigned URL expires 7 days after export creation
- User can regenerate export if link expires (counts as new export toward monthly limit)

---

## 5. Analytics Event Model

### Event Structure

```json
{
  "event_id": "uuid-v4",                // Primary key
  "event_name": "calculation_performed", // Event type
  "timestamp": "2025-01-15T14:30:05Z",  // Event occurrence time

  "session_id": "uuid-v4",              // Pseudonymous identifier (anonymous users)
  "user_id": "uuid-v4",                 // Pseudonymous identifier (registered users, null for anonymous)
  "tenant_id": null,                    // Foreign key (for B2B tenant analytics)

  "properties": {                       // Event-specific data (JSON)
    "calculator_id": "business-loan",
    "inputs_hash": "sha256-hash",       // Hash of inputs (for cache hit tracking, not reversible)
    "calculation_time_ms": 142,
    "tier": "free",
    "warnings_count": 1
  },

  "metadata": {
    "user_agent": "Mozilla/5.0...",     // Browser/device info
    "ip_hash": "sha256-hash",           // IP address hashed (for abuse detection, not reversible)
    "referrer": "https://google.com",   // Traffic source
    "locale": "en-US"
  }
}
```

**Storage**:
- **Events table** (PostgreSQL) or ClickHouse (for high volume, Phase 2+)
- **Partitioned by month** (e.g., `events_2025_01`, `events_2025_02`)
- **Retention**: 12 months, then auto-purge (per Section 1.6)

---

### Session Tracking

**Anonymous users**:
- `session_id` stored in httpOnly cookie
- Session expires after 30 days of inactivity
- Session ID is pseudonymous UUID (not tied to PII)

**Registered users**:
- `user_id` is pseudonymous UUID (not email or name in analytics)
- `session_id` still tracked (to distinguish sessions from same user)
- Analytics queries join on `user_id` for cohort analysis

---

### Event Aggregation Approach

**Raw events** (stored 12 months):
- Individual events: `calculation_performed`, `export_requested`, `tier_upgraded`

**Aggregated summaries** (stored indefinitely):
- Daily rollups: "1,234 calculations on 2025-01-15 for business-loan calculator"
- Monthly rollups: "45,678 calculations in Jan 2025, 3.2% conversion Free → Pro"
- Aggregations stored in separate `analytics_rollups` table

**Aggregation jobs**:
- Run nightly (aggregate previous day's events)
- After 12 months, drop raw events, keep aggregated summaries

---

## Data Model Relationships Diagram

```
┌─────────────┐
│   Tenants   │
└──────┬──────┘
       │ 1:N
       │
┌──────▼──────┐       ┌──────────────┐
│    Users    │───────│   Sessions   │
│             │  1:N  │  (anonymous) │
└──────┬──────┘       └──────┬───────┘
       │ 1:N                 │ 1:N
       │                     │
┌──────▼─────────────────────▼───────┐
│            Scenarios               │
└──────┬─────────────────────────────┘
       │ 1:N
       │
┌──────▼──────┐       ┌──────────────┐
│   Exports   │       │   Events     │
└─────────────┘       └──────────────┘
```

---

## Summary

These data models support:
- **Multi-tier access**: Free, Pro, AI, B2B with appropriate limits and features
- **Multi-tenancy**: B2B customers with isolated data and custom branding
- **Minimal PII**: Only email and name (for registered users); all analytics use pseudonymous IDs
- **Audit trails**: Formula versions, calculation timestamps, export metadata
- **GDPR/CCPA compliance**: User data export and hard deletion capabilities
- **Retention policies**: Automated cleanup of expired scenarios, exports, and events (per Section 5.4)
