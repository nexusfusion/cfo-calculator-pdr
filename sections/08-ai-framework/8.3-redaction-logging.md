# 8.3 Redaction, Logging, and Opt-Out

This section defines what data gets logged when AI features are used, what information is redacted (not sent to AI providers), and how tenants can control AI behavior via opt-out and redaction settings.

---

## Redaction Philosophy

**Guiding principle**: Minimize data sent to external AI providers (per Section 5.2 privacy requirements)

**Default posture**: **Strict redaction**—only send structured numeric data to AI, redact all free-text, names, and identifying information by default. Opt-in required to send any additional data.

**Rationale**:
- Protect user privacy (AI providers may retain data for training or compliance)
- Reduce legal risk (minimize PII exposure in case of AI provider breach)
- Build trust with B2B customers (especially regulated industries like finance, healthcare)

---

## 1. AI Request Logging

When a user makes an AI request (e.g., clicks "Explain this result"), the system logs **metadata only**—not the full prompt or AI response text.

### What gets logged

**Logged to analytics database** (ClickHouse or PostgreSQL):

```json
{
  "event_name": "ai_narrative_requested",
  "timestamp": "2025-11-17T21:45:00Z",
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "user_id": "e8f5a3c2-1234-5678-9abc-def012345678",
  "tier": "ai",
  "calculator_slug": "business-loan-dscr",
  "ai_request_type": "explain_result",
  "response_time_ms": 2340,
  "success": true,
  "summary": "DSCR explanation requested",
  "ai_provider": "anthropic",
  "ai_model": "claude-sonnet-4",
  "prompt_version": "dscr_explanation_v1",
  "tokens_used": 742
}
```

**Fields explained**:
- `session_id`, `user_id`: Pseudonymous identifiers (UUIDs, not email/name)
- `calculator_slug`: Which calculator AI was used in
- `ai_request_type`: Type of request (explain_result, suggest_scenario, risk_commentary)
- `response_time_ms`: Latency from request to response (for performance monitoring)
- `success`: Boolean (true if AI responded, false if error/timeout)
- `summary`: High-level description (e.g., "DSCR explanation requested"), **not full prompt text**
- `ai_provider`: Which AI provider used (anthropic, openai, etc.)
- `ai_model`: Which model used (claude-sonnet-4, gpt-4, etc.)
- `prompt_version`: Version of prompt template (for A/B testing)
- `tokens_used`: Total tokens consumed (for cost tracking)

### What does NOT get logged

**Never logged** (to protect privacy and reduce storage costs):
- **Full prompt text** (contains user inputs, could be reconstructed to identify business)
- **Full AI response text** (could contain inferred business details)
- **User PII**: email, name, company name, counterparty names
- **Specific numeric inputs**: exact loan amounts, revenue figures, expense details
- **Free-text notes**: user-entered notes, scenario names, descriptions

**Rationale**:
- Full prompts/responses are ephemeral (used once, then discarded)
- Logging full text would create a PII data store requiring stricter compliance
- Summary + metadata is sufficient for analytics and debugging

### Log retention

**Retention period**: 12 months (per Section 5.4)

**Deletion**:
- After 12 months, AI request logs are automatically deleted
- No archival or long-term storage (minimize data retention risk)

**Compliance**:
- Pseudonymous IDs only (session_id, user_id as UUIDs)
- No PII in logs (GDPR-compliant, CCPA-compliant)
- Users can request deletion via "Delete my data" in account settings

---

## 2. AI Suggestion Logging

When AI suggests input changes (e.g., "Try increasing revenue by 10%"), the system logs **which suggestion was made**—but not the full text.

### What gets logged

**Logged when suggestion is displayed**:

```json
{
  "event_name": "ai_suggestion_displayed",
  "timestamp": "2025-11-17T21:46:00Z",
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "user_id": "e8f5a3c2-1234-5678-9abc-def012345678",
  "tier": "ai",
  "calculator_slug": "business-loan-dscr",
  "scenario_id": "a1b2c3d4-5678-90ab-cdef-1234567890ab",
  "suggestion_type": "extend_term",
  "suggestion_summary": "Suggested extending loan term from 10 to 15 years",
  "suggestion_count": 3
}
```

**Logged when user accepts suggestion**:

```json
{
  "event_name": "ai_suggestion_accepted",
  "timestamp": "2025-11-17T21:47:00Z",
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "user_id": "e8f5a3c2-1234-5678-9abc-def012345678",
  "tier": "ai",
  "calculator_slug": "business-loan-dscr",
  "scenario_id": "a1b2c3d4-5678-90ab-cdef-1234567890ab",
  "suggestion_type": "extend_term"
}
```

**Fields explained**:
- `suggestion_type`: Category of suggestion (extend_term, increase_revenue, reduce_expenses, larger_down_payment)
- `suggestion_summary`: High-level description (not full AI text)
- `suggestion_count`: How many suggestions were shown (typically 3)

### User must explicitly accept suggestions

**Critical rule**: AI never automatically applies suggestions to user scenarios

**Implementation**:
1. AI suggests: "Consider extending the loan term from 10 to 15 years"
2. User sees suggestion in UI with button: "Apply this suggestion"
3. User clicks button (explicit consent)
4. System creates new scenario with suggested inputs
5. Log `ai_suggestion_accepted` event

**Rationale**:
- Prevent AI from corrupting user data
- Ensure user understands what is changing
- Audit trail of AI influence on decisions

---

## 3. Tenant-Level AI Controls (B2B)

B2B customers (white-label tier, Section 1.5) can configure AI behavior per tenant via admin settings.

### Control options

**AI enabled/disabled**:
- **Fully enabled** (default for AI tier): All AI features available
- **Fully disabled**: No AI calls made, no data sent to AI providers, "Explain this result" buttons hidden in UI

**Redaction levels**:
- **Disabled**: AI completely off (no redaction needed)
- **Strict**: Only high-level aggregates sent (ranges, not exact values)
- **Standard** (default): Numeric inputs/outputs sent, no free-text
- **Enhanced** (opt-in only): Free-text fields allowed (requires explicit configuration and user consent)

### Configuration storage

**Database table**: `tenant_configs`

```sql
CREATE TABLE tenant_configs (
  tenant_id UUID PRIMARY KEY,
  ai_enabled BOOLEAN DEFAULT true,
  ai_redaction_level VARCHAR(20) DEFAULT 'standard',
  ai_provider VARCHAR(50) DEFAULT 'anthropic',
  ai_custom_endpoint VARCHAR(255) DEFAULT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

**Fields explained**:
- `ai_enabled`: true (AI features on) or false (AI features completely disabled)
- `ai_redaction_level`: 'disabled', 'strict', 'standard', 'enhanced'
- `ai_provider`: 'anthropic' (default), 'openai', 'custom' (for on-premises)
- `ai_custom_endpoint`: URL for self-hosted AI (e.g., "https://ai.customer.com/v1/chat")

### Redaction level behavior

**Disabled** (ai_enabled = false):
- No AI calls made (all AI features off)
- "Explain this result" buttons hidden in UI
- No data sent to AI providers (maximum privacy)

**Strict** (ai_redaction_level = 'strict'):
- Only high-level aggregates sent to AI
- Example: "Annual revenue between $1.0M-$2.0M" (not "$1,500,000")
- Example: "DSCR between 1.25-1.50" (not "1.42")
- No free-text, no scenario names, no exact values
- **Use case**: Highly regulated industries (finance, healthcare) where even numeric data is sensitive

**Standard** (ai_redaction_level = 'standard', default):
- Numeric inputs and outputs sent to AI (exact values)
- No free-text notes, no scenario names, no counterparty names
- Example: "Annual revenue of $1,500,000, DSCR of 1.42"
- **Use case**: Default for most customers (balance between AI quality and privacy)

**Enhanced** (ai_redaction_level = 'enhanced', opt-in only):
- Numeric inputs/outputs + free-text notes (if user consents)
- User must explicitly enable per scenario: "Allow AI to analyze my notes"
- Scenario names still redacted by default
- **Use case**: Users who want AI to consider qualitative context (e.g., "This is for our Oakland expansion")
- **Warning**: Shown to user before enabling: "Your notes will be sent to our AI provider (Anthropic). Do not include confidential or sensitive information."

### UI behavior per redaction level

**Disabled**:
- "Explain this result" buttons hidden
- If user is on AI tier but tenant disabled AI, show message: "AI features are disabled by your organization admin."

**Strict**:
- "Explain this result" buttons visible
- AI responses may be less specific (due to range aggregation)
- Example response: "Your DSCR is in the 1.25-1.50 range, which typically meets lender requirements."

**Standard** (default):
- "Explain this result" buttons visible
- AI responses are specific and accurate
- Example response: "Your DSCR of 1.42 is comfortably above the typical 1.25 lender requirement."

**Enhanced**:
- "Explain this result" buttons visible
- Checkbox in scenario settings: "☐ Allow AI to analyze my notes for this scenario"
- If checked, free-text notes sent to AI (with user consent)
- If unchecked, falls back to Standard redaction

---

## 4. On-Premises AI (B2B Option)

Some B2B customers may want AI features but refuse to send any data to external providers (e.g., due to regulatory requirements, data sovereignty laws, or confidentiality policies).

### Solution: Self-hosted AI

**Customer responsibilities**:
- Host their own LLM (e.g., self-hosted Claude via AWS Bedrock, Llama via Ollama, or GPT via Azure OpenAI)
- Expose an API endpoint compatible with our prompt format
- Ensure uptime, performance, and cost management

**Our responsibilities**:
- Configure tenant to use custom endpoint (set `ai_custom_endpoint` in tenant_configs)
- Send prompts to customer's endpoint instead of Anthropic API
- Provide prompt format documentation (so customer can configure their LLM)

### Implementation

**Configuration**:
```sql
UPDATE tenant_configs
SET ai_provider = 'custom',
    ai_custom_endpoint = 'https://ai.customer.com/v1/chat'
WHERE tenant_id = 'customer-uuid';
```

**API call**:
```typescript
const endpoint = tenant.ai_custom_endpoint || 'https://api.anthropic.com/v1/messages';

const response = await fetch(endpoint, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${apiKey}`, // Customer's API key, not ours
  },
  body: JSON.stringify({
    model: 'claude-sonnet-4', // Or customer's model
    messages: [
      { role: 'system', content: systemPrompt },
      { role: 'user', content: userPrompt },
    ],
  }),
});
```

**Compatibility requirements**:
- Customer's endpoint must accept same request format as Anthropic API (or OpenAI API)
- Customer must return response in same format (JSON with `content` field)
- If customer uses incompatible format, adapter layer required (custom implementation)

### Support and pricing

**Scope**: Out of scope for v1 (Phase 1-2)

**Planned for Phase 3+**:
- Requires separate implementation agreement
- Additional support fee (e.g., +$500/month for custom endpoint support)
- Customer is responsible for AI costs (we don't charge per-request, they pay their LLM provider)

**Use cases**:
- Financial institutions (regulatory compliance)
- Healthcare (HIPAA compliance, PHI data restrictions)
- Government contractors (data sovereignty requirements)

---

## 5. User-Level AI Opt-Out

Individual users (not just tenants) can opt out of AI features entirely via account settings.

### Opt-out mechanism

**Account settings** (`/settings/privacy`):
```
☑ Enable AI features (explanations and suggestions)

When enabled, your calculation data may be sent to our AI provider (Anthropic)
for generating explanations and suggestions. We do not send personally
identifiable information (PII) or free-text notes by default. Learn more.

[Save Settings]
```

**Database field**:
```sql
ALTER TABLE users ADD COLUMN ai_opt_out BOOLEAN DEFAULT false;
```

**Behavior when opted out** (`ai_opt_out = true`):
- "Explain this result" buttons hidden in UI
- No AI calls made for this user (even if tier includes AI)
- User's AI request quota is not consumed (counter stays at 0)

**Use case**:
- Users who don't trust AI or prefer manual analysis
- Users concerned about data privacy (even pseudonymous data)
- Users who don't want to consume AI quota (save it for later)

---

## 6. GDPR and Data Deletion

Users can request deletion of all their data, including AI request logs.

### Deletion process

**User action**: Click "Delete my account" in settings

**System action**:
1. Delete all user scenarios from `scenarios` table
2. Delete all exports from `exports` table and S3/R2 storage
3. Delete user record from `users` table
4. **Pseudonymize** AI request logs (do not delete, per analytics retention):
   - Set `user_id = NULL` in all AI request logs
   - Logs become anonymous (session_id only)
   - Allows aggregate analytics (e.g., "total AI requests per month") without PII

**Rationale**:
- GDPR right to erasure (delete PII)
- Retain anonymized analytics for business intelligence (allowed under GDPR Article 89)

**Timeline**: Deletion completes within 30 days

---

## Summary

AI redaction, logging, and opt-out controls provide:

**AI request logging**:
- Log metadata only (session_id, calculator_slug, ai_request_type, response_time_ms, success)
- Never log full prompts or AI responses (ephemeral, discarded after use)
- 12-month retention, then auto-delete

**AI suggestion logging**:
- Log suggestion type and summary (not full text)
- User must explicitly accept suggestions (AI never auto-applies)
- Track acceptance rate for product analytics

**Tenant-level AI controls**:
- AI enabled/disabled (completely on or off)
- Redaction levels: Disabled, Strict (ranges), Standard (exact values), Enhanced (free-text opt-in)
- Stored in `tenant_configs` table (per-tenant configuration)

**On-premises AI** (future, Phase 3+):
- Customer hosts own LLM (self-hosted Claude, Llama, GPT)
- We call customer's endpoint instead of Anthropic API
- Requires separate support agreement

**User-level opt-out**:
- Users can disable AI features in account settings
- `ai_opt_out = true` hides AI buttons, stops AI calls
- Even if tier includes AI, opt-out is respected

**GDPR compliance**:
- User deletion pseudonymizes AI logs (sets user_id = NULL)
- Allows aggregate analytics without PII
- Deletion completes within 30 days
