# 12.4 Deployment Pipeline

## Overview

The deployment pipeline is the automated system that takes a calculator JSON file from creation to production in approximately 5-10 minutes. This pipeline ensures quality, consistency, and reliability through automated validation and testing.

**Pipeline goals:**
- **Speed:** 5-10 minutes from commit to live calculator
- **Quality:** Catch errors before production through automated validation
- **Zero-downtime:** Blue-green deployments with instant rollback
- **Traceability:** Full audit trail of all changes via Git

**Technology stack:**
- **Version control:** Git + GitHub
- **CI/CD:** GitHub Actions
- **Hosting:** Railway (Phase 1), AWS (Phase 2+)
- **Deployment strategy:** Blue-green with health checks

---

## Deployment Flow Overview

```
Developer creates/edits JSON
         ↓
Commit to feature branch
         ↓
Push to GitHub
         ↓
GitHub Actions triggered
         ↓
[VALIDATION STAGE]
  ├─ JSON schema validation
  ├─ Formula library check
  ├─ Tier config validation
  └─ Golden scenario testing
         ↓
All validations pass?
  ├─ YES → PR approved, merge allowed
  └─ NO → Build fails, PR blocked
         ↓
Merge to main branch
         ↓
[BUILD STAGE]
  ├─ UI components generated
  ├─ Formula library wired
  ├─ Export templates created
  └─ WordPress shortcode generated
         ↓
Deploy to staging
         ↓
[STAGING QA]
  ├─ Health check (calculator loads)
  ├─ Smoke test (run one calculation)
  └─ Golden scenario validation
         ↓
Deploy to production (blue-green)
         ↓
[PRODUCTION VERIFICATION]
  ├─ Health check
  ├─ Smoke test
  └─ Monitor error rates (24 hours)
         ↓
Calculator live ✓
```

**Total time:** ~5-10 minutes (commit to live)

---

## Stage 1: Create/Edit JSON Config

**Developer workflow:**

1. **Clone repository**
   ```bash
   git clone https://github.com/smartprofit/calculator-suite.git
   cd calculator-suite
   ```

2. **Create feature branch**
   ```bash
   git checkout -b calculators/add-roi-calculator
   ```

3. **Create JSON config**
   - Location: `/calculators/configs/roi-calculator.json`
   - Copy from template or existing calculator
   - Follow schema from Section 12.2

4. **(Optional) Create golden scenarios**
   - Location: `/calculators/configs/roi-calculator.golden.json`
   - Define expected inputs and outputs for testing

**Time:** ~3-5 minutes (for experienced developer)

---

## Stage 2: Automated Validation (CI/CD)

**Triggered by:** Push to any branch

**GitHub Actions workflow file:** `.github/workflows/validate-calculator.yml`

```yaml
name: Validate Calculator JSON

on:
  push:
    branches: ['**']
    paths:
      - 'calculators/configs/**/*.json'
  pull_request:
    paths:
      - 'calculators/configs/**/*.json'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: JSON Schema Validation
        run: npm run validate:schema

      - name: Formula Library Check
        run: npm run validate:formulas

      - name: Tier Config Validation
        run: npm run validate:tiers

      - name: Golden Scenario Testing
        run: npm run test:golden-scenarios

      - name: Generate validation report
        if: failure()
        run: npm run report:validation-errors
```

**Validation steps:**

### 2.1 JSON Schema Validation

**Purpose:** Ensure JSON file is syntactically valid and matches schema (Section 12.2)

**Script:** `npm run validate:schema`

**Checks:**
- Is the file valid JSON?
- Does it have all required top-level sections? (calculator_meta, inputs, calculations, outputs)
- Are all field types correct? (strings, numbers, booleans, arrays)
- Do all enum fields have valid values? (category, field_type, severity, etc.)
- Are all required fields present?
- Do all fields meet validation constraints? (min, max, string length, etc.)

**Example validation output (success):**
```
✓ calculators/configs/roi-calculator.json
  ✓ JSON syntax valid
  ✓ Schema structure valid
  ✓ All required fields present
  ✓ All field types correct
  ✓ All enum values valid
  ✓ All validation constraints satisfied

Schema validation: PASSED
```

**Example validation output (failure):**
```
✗ calculators/configs/roi-calculator.json
  ✓ JSON syntax valid
  ✓ Schema structure valid
  ✗ Field validation error:
    - inputs[2].field_type: "slider" is not a valid field_type
      Valid values: number, currency, percentage, dropdown, slider
    - calculations[0].formula_function: "calculateROI" not found in formula library
    - tier_config.free_tier.visible_outputs[0]: "monthly_roi" does not reference a valid metric_id

Schema validation: FAILED (3 errors)
```

**Exit code:** 0 = success, 1 = failure (blocks PR merge)

---

### 2.2 Formula Library Check

**Purpose:** Ensure all referenced formula functions exist in the formula library

**Script:** `npm run validate:formulas`

**Checks:**
- Do all `formula_function` values in calculations array exist in formula library?
- Do input counts match formula signatures? (e.g., calculateMonthlyPayment expects 3 inputs)
- Are output_variable names unique?

**Example validation output (success):**
```
✓ Formula library check: calculators/configs/roi-calculator.json
  ✓ calculateROI: Found in formula library v1.2.0
  ✓ calculatePaybackPeriod: Found in formula library v1.2.0
  ✓ Input count matches signature (3 inputs expected, 3 provided)
  ✓ All output_variable names unique

Formula validation: PASSED
```

**Example validation output (failure):**
```
✗ Formula library check: calculators/configs/roi-calculator.json
  ✗ calculateROI: Not found in formula library v1.2.0
    Available similar formulas:
      - calculateNPV
      - calculateIRR
    Suggestion: Add calculateROI to formula library or use existing formula

Formula validation: FAILED (1 error)
```

**Exit code:** 0 = success, 1 = failure (blocks PR merge)

---

### 2.3 Tier Config Validation

**Purpose:** Ensure tier gating rules are logically consistent

**Script:** `npm run validate:tiers`

**Checks:**
- Do all metric_ids in `visible_outputs` exist in outputs section?
- Is `free_tier.max_scenarios` ≤ `pro_tier.max_scenarios`?
- Are scenario limits valid numbers (> 0)?
- If `ai_enabled: true`, is there an `ai_config` section?

**Example validation output (success):**
```
✓ Tier config validation: calculators/configs/roi-calculator.json
  ✓ All free_tier.visible_outputs reference valid metric_ids
  ✓ All pro_tier.visible_outputs reference valid metric_ids
  ✓ Scenario limits logical (free: 1, pro: 50)
  ✓ AI config present (ai_enabled: true)

Tier validation: PASSED
```

**Example validation output (failure):**
```
✗ Tier config validation: calculators/configs/roi-calculator.json
  ✗ free_tier.visible_outputs[2]: "total_roi" does not exist in outputs
    Available metric_ids: monthly_roi, annual_roi, payback_period
  ✗ ai_enabled: true but ai_config section missing

Tier validation: FAILED (2 errors)
```

**Exit code:** 0 = success, 1 = failure (blocks PR merge)

---

### 2.4 Golden Scenario Testing

**Purpose:** Validate calculator outputs against known correct values (if golden scenarios provided)

**Script:** `npm run test:golden-scenarios`

**Checks:**
- If `/calculators/configs/{calculator-slug}.golden.json` exists, run tests
- Execute calculations with golden inputs
- Compare outputs to expected values (within tolerance, typically ±0.01 for currency)
- Report any mismatches

**Golden scenario file format:**
```json
{
  "calculator_slug": "roi-calculator",
  "scenarios": [
    {
      "name": "Standard investment",
      "inputs": {
        "initial_investment": 100000,
        "annual_return": 15000,
        "holding_period_years": 5
      },
      "expected_outputs": {
        "total_roi": 75000,
        "roi_percentage": 75.0,
        "annualized_roi": 15.0
      },
      "tolerance": 0.01
    }
  ]
}
```

**Example validation output (success):**
```
✓ Golden scenario testing: calculators/configs/roi-calculator.json
  ✓ Scenario 1: "Standard investment"
    Inputs: initial_investment=100000, annual_return=15000, holding_period_years=5
    Expected: total_roi=75000, roi_percentage=75.0, annualized_roi=15.0
    Actual:   total_roi=75000.00, roi_percentage=75.00, annualized_roi=15.00
    Status: PASSED (all outputs within tolerance ±0.01)

Golden scenario validation: PASSED (1/1 scenarios)
```

**Example validation output (failure):**
```
✗ Golden scenario testing: calculators/configs/roi-calculator.json
  ✗ Scenario 1: "Standard investment"
    Inputs: initial_investment=100000, annual_return=15000, holding_period_years=5
    Expected: total_roi=75000, roi_percentage=75.0, annualized_roi=15.0
    Actual:   total_roi=75000.00, roi_percentage=75.00, annualized_roi=12.50
    Status: FAILED
      - annualized_roi: Expected 15.0, got 12.50 (difference: 2.50, tolerance: ±0.01)

Golden scenario validation: FAILED (0/1 scenarios passed)
```

**Exit code:** 0 = success, 1 = failure (blocks PR merge)

**Note:** Golden scenarios are optional but highly recommended for complex calculators (5+ calculation steps)

---

### Validation Summary Report

After all validation steps, a summary report is generated:

**Success report:**
```
═══════════════════════════════════════════════════
  CALCULATOR VALIDATION REPORT
═══════════════════════════════════════════════════
Calculator: roi-calculator.json
Status: ✓ PASSED

Validation Results:
  ✓ JSON Schema Validation       PASSED
  ✓ Formula Library Check         PASSED
  ✓ Tier Config Validation        PASSED
  ✓ Golden Scenario Testing       PASSED (1/1)

Summary:
  Total checks: 4
  Passed: 4
  Failed: 0

This calculator is ready for deployment.
Pull request can be merged to main branch.
═══════════════════════════════════════════════════
```

**Failure report:**
```
═══════════════════════════════════════════════════
  CALCULATOR VALIDATION REPORT
═══════════════════════════════════════════════════
Calculator: roi-calculator.json
Status: ✗ FAILED

Validation Results:
  ✓ JSON Schema Validation       PASSED
  ✗ Formula Library Check         FAILED (1 error)
  ✓ Tier Config Validation        PASSED
  ✗ Golden Scenario Testing       FAILED (0/1 scenarios passed)

Errors:
  1. Formula Library Check:
     - calculateROI: Not found in formula library v1.2.0

  2. Golden Scenario Testing:
     - Scenario "Standard investment": annualized_roi mismatch
       Expected: 15.0, Got: 12.50

Summary:
  Total checks: 4
  Passed: 2
  Failed: 2

This calculator cannot be deployed.
Please fix errors and push again.
═══════════════════════════════════════════════════
```

**Time:** ~1-2 minutes (validation scripts run in parallel)

---

## Stage 3: Build Stage

**Triggered by:** Merge to main branch

**GitHub Actions workflow file:** `.github/workflows/build-deploy.yml`

### 3.1 UI Component Generation

**Script:** `npm run generate:ui`

**Process:**
1. Read calculator JSON
2. Parse `inputs` array
3. For each input, generate React component based on `field_type`:
   - `currency` → `<CurrencyInput />`
   - `percentage` → `<PercentageInput />`
   - `number` → `<NumberInput />`
   - `dropdown` → `<DropdownInput />`
4. Apply validation rules (min, max, required, etc.)
5. Wire onChange handlers to state management
6. Apply design system styles (Section 4)

**Generated file:** `/src/components/calculators/generated/ROICalculator.tsx`

**Example generated component (simplified):**
```typescript
// Auto-generated by JSON Assembly Line
// DO NOT EDIT MANUALLY

import React from 'react';
import { CurrencyInput, NumberInput } from '@/components/inputs';
import { useCalculator } from '@/hooks/useCalculator';

export const ROICalculator: React.FC = () => {
  const { inputs, setInput, calculate, results } = useCalculator('roi-calculator');

  return (
    <div className="calculator-container">
      <div className="inputs-section">
        <CurrencyInput
          id="initial_investment"
          label="Initial Investment"
          value={inputs.initial_investment}
          onChange={(value) => setInput('initial_investment', value)}
          required={true}
          min={1000}
          max={100000000}
          placeholder="100000"
          tooltip="The total amount you are investing."
        />

        {/* More inputs generated... */}
      </div>

      <button onClick={calculate}>Calculate</button>

      <div className="results-section">
        {results && <ResultsDisplay results={results} config={calculatorConfig} />}
      </div>
    </div>
  );
};
```

---

### 3.2 Formula Library Wiring

**Script:** `npm run generate:formulas`

**Process:**
1. Read `calculations` array from JSON
2. Generate calculation execution logic
3. Wire formula library function calls
4. Handle dependencies (step B depends on step A output)
5. Generate execution order (topological sort of dependencies)

**Generated file:** `/src/lib/calculators/generated/roi-calculator.ts`

**Example generated logic (simplified):**
```typescript
// Auto-generated calculation logic
import { calculateROI, calculatePaybackPeriod } from '@/lib/formulas';

export function executeROICalculations(inputs: ROIInputs): ROIOutputs {
  // Step 1: calc_total_roi
  const total_roi = calculateROI(
    inputs.initial_investment,
    inputs.annual_return,
    inputs.holding_period_years
  );

  // Step 2: calc_roi_percentage (depends on step 1)
  const roi_percentage = (total_roi / inputs.initial_investment) * 100;

  // Step 3: calc_payback_period
  const payback_period = calculatePaybackPeriod(
    inputs.initial_investment,
    inputs.annual_return
  );

  return {
    total_roi,
    roi_percentage,
    payback_period
  };
}
```

---

### 3.3 Export Template Generation

**Script:** `npm run generate:exports`

**Process:**
1. Read `export_config` section from JSON
2. Generate PDF template based on `pdf_sections`
3. Generate CSV structure based on `csv_columns`
4. Include watermark logic for Free tier

**Generated files:**
- `/src/lib/exports/templates/roi-calculator-pdf.ts`
- `/src/lib/exports/templates/roi-calculator-csv.ts`

---

### 3.4 WordPress Shortcode Generation

**Script:** `npm run generate:shortcodes`

**Process:**
1. Generate WordPress shortcode for embedding calculator
2. Document shortcode parameters
3. Update shortcode documentation

**Generated shortcode:**
```
[cfo_calculator slug="roi-calculator"]
```

**Shortcode parameters:**
```
[cfo_calculator slug="roi-calculator" tier="pro" hide_export="false"]
```

**Documentation updated:** `/docs/wordpress-shortcodes.md`

**Time (Build Stage):** ~2-3 minutes

---

## Stage 4: Deploy to Staging

**Environment:** staging.smartprofit.com

**Deployment method:** Blue-green (zero downtime)

**Process:**
1. Build Docker container with new calculator
2. Deploy to staging environment (green instance)
3. Run health checks
4. Run smoke tests
5. If all pass, switch traffic to green instance
6. If any fail, keep traffic on blue instance (current production)

**Health checks:**
- Calculator page loads (HTTP 200)
- JSON config loads correctly
- UI components render without errors

**Smoke tests:**
- Enter sample inputs
- Trigger calculation
- Verify outputs are numbers (not NaN or undefined)
- Verify at least one output is non-zero

**Time:** ~1-2 minutes

---

## Stage 5: Deploy to Production

**Environment:** app.smartprofit.com

**Deployment method:** Blue-green (zero downtime)

**Process:**
1. Build production Docker container
2. Deploy to production green instance
3. Run health checks
4. Run smoke tests
5. Run golden scenarios (if provided)
6. If all pass, switch traffic to green instance
7. Monitor error rates for first 24 hours

**Post-deployment monitoring (first 24 hours):**
- Error rate < 0.1% (Section 1.6)
- p95 calculation latency < 150ms (Section 1.6)
- No crashes or unhandled exceptions
- Calculator usage events tracked (Section 7)

**Rollback trigger:**
- Error rate > 1% for 5 consecutive minutes
- 3+ crashes in first hour
- Critical bug reported by user

**Rollback process:**
1. Revert Git commit: `git revert HEAD`
2. Push to main branch
3. Deployment pipeline re-runs automatically
4. Previous version deployed in < 5 minutes

**Time (Production Deployment):** ~2-3 minutes

---

## Post-Deployment Verification

### Health Check

**Script:** `npm run health:check`

**Checks:**
- Calculator page accessible (HTTP 200)
- JSON config loads
- Formula library functions available
- No JavaScript errors in console

**Example output:**
```
✓ Health Check: roi-calculator
  ✓ GET /calculators/roi-calculator → 200 OK
  ✓ JSON config loaded successfully
  ✓ Formula library initialized
  ✓ No console errors

Health check: PASSED
```

---

### Smoke Test

**Script:** `npm run smoke:test`

**Process:**
1. Navigate to calculator page
2. Enter sample inputs (from golden scenario if available, or defaults)
3. Click "Calculate"
4. Verify results display
5. Verify no errors

**Example output:**
```
✓ Smoke Test: roi-calculator
  ✓ Page loaded
  ✓ Input fields rendered (3 inputs)
  ✓ Entered sample inputs
  ✓ Clicked "Calculate"
  ✓ Results displayed (3 outputs)
  ✓ No errors in console

Smoke test: PASSED
```

---

### Monitoring (First 24 Hours)

**Metrics tracked (Section 7):**
- `calculator_loaded` event count
- `calculation_executed` event count
- `calculation_error` event count (should be near zero)
- p95 calculation latency (should be < 150ms)

**Alert thresholds:**
- Error rate > 1% for 5 minutes → Slack alert to #engineering
- p95 latency > 500ms for 10 minutes → Slack alert to #engineering
- Zero `calculator_loaded` events in first hour → Slack alert (possible deployment issue)

**Time (Post-Deployment):** Ongoing for 24 hours

---

## Complete Timeline

| Stage | Time | Cumulative |
|-------|------|------------|
| Create/edit JSON config | 3-5 min | 3-5 min |
| Commit and push to GitHub | 30 sec | 3.5-5.5 min |
| Automated validation (CI/CD) | 1-2 min | 4.5-7.5 min |
| Build stage (UI, formulas, exports) | 2-3 min | 6.5-10.5 min |
| Deploy to staging | 1-2 min | 7.5-12.5 min |
| Deploy to production | 2-3 min | 9.5-15.5 min |
| Post-deployment verification | 1 min | 10.5-16.5 min |

**Typical total time:** ~10-12 minutes (from JSON creation to live calculator)

**Best case:** ~7 minutes (experienced developer, simple calculator, all validations pass first try)

**Worst case:** ~20 minutes (validation failures, need to fix and re-run)

---

## Rollback Process

**When to rollback:**
- Critical bug discovered in production
- Error rate > 1% for 5 consecutive minutes
- Calculator crashes or returns incorrect results

**Rollback steps:**

1. **Revert Git commit**
   ```bash
   git revert HEAD
   git push origin main
   ```

2. **Deployment pipeline runs automatically**
   - Previous calculator version re-deployed
   - Same validation + build + deploy process
   - Takes ~5 minutes

3. **Verify rollback successful**
   - Run health check
   - Run smoke test
   - Confirm error rate returns to normal

4. **Investigate and fix issue**
   - Analyze error logs
   - Fix bug in JSON config or formula library
   - Create new feature branch with fix
   - Re-run deployment pipeline

**Rollback time:** < 5 minutes (from decision to rollback to previous version live)

---

## CI/CD Configuration

**GitHub Actions workflow files:**

### `.github/workflows/validate-calculator.yml`
Runs on push to any branch, validates JSON files.

### `.github/workflows/build-deploy.yml`
Runs on merge to main, builds and deploys to production.

### `.github/workflows/rollback.yml`
Manual workflow for emergency rollbacks.

**Environment variables (GitHub Secrets):**
- `RAILWAY_TOKEN` (Phase 1 deployment)
- `AWS_ACCESS_KEY_ID` (Phase 2 deployment)
- `AWS_SECRET_ACCESS_KEY` (Phase 2 deployment)
- `SLACK_WEBHOOK_URL` (for alerts)

---

## Deployment Checklist

**Before creating calculator JSON:**
- [ ] Calculator design approved (Section 11 calculator PDR template)
- [ ] Required formulas exist in formula library (Section 12.3)
- [ ] Tier gating strategy defined (Free vs Pro features)
- [ ] Golden scenarios prepared (recommended for complex calculators)

**Before pushing to GitHub:**
- [ ] JSON file follows schema (Section 12.2)
- [ ] All referenced formulas exist in library
- [ ] Tier config is logically consistent
- [ ] Golden scenarios included (optional but recommended)
- [ ] Calculator slug is unique (checked against existing calculators)

**Before merging to main:**
- [ ] All CI/CD validations passed
- [ ] Code review approved (if team has code review policy)
- [ ] Documentation updated (if needed)

**After deployment:**
- [ ] Health check passed
- [ ] Smoke test passed
- [ ] WordPress shortcode documented (if embedding in WordPress)
- [ ] Monitor error rates for first 24 hours

---

## Next Steps

- **Section 12.5:** Complete calculator examples (simple, moderate, complex) showing full JSON configurations and deployment results
