# 3.3 Module Boundaries

This section defines the shared modules that all calculators consume. Clear module boundaries accelerate calculator development, ensure consistency across the suite, and prevent code duplication. Each module has a well-defined API/interface, versioning strategy, and consumption pattern.

---

## 1. Finance Math Library

### Purpose

The Finance Math Library is the shared calculation engine that implements all financial formulas used across calculators. This module ensures:
- **Consistency**: DSCR calculated the same way in Business Loan Calculator and Equipment Lease Calculator
- **Auditability**: Formulas are versioned and regression-tested against reference models (Â±0.1% tolerance per Section 1.6)
- **Reusability**: NPV/IRR functions used by 4+ calculators (Equipment Lease, Valuation, Line of Credit, Project ROI)

### API/Interface

The library exports pure TypeScript functions with strongly typed inputs and outputs:

```typescript
// Amortization calculation
interface LoanInputs {
  principal: number;      // Loan amount in dollars
  annualRate: number;     // Interest rate (e.g., 0.075 for 7.5%)
  termMonths: number;     // Loan term in months
  originationFee?: number; // Optional origination fee
}

interface AmortizationResult {
  monthlyPayment: number;
  totalInterest: number;
  totalCost: number;
  schedule: Array<{
    month: number;
    payment: number;
    principal: number;
    interest: number;
    balance: number;
  }>;
  version: string;        // Formula version (e.g., "1.3.2")
}

export function calculateAmortization(inputs: LoanInputs): AmortizationResult;

// DSCR calculation
interface DSCRInputs {
  annualDebtService: number;  // Total annual debt payments
  netOperatingIncome: number; // Annual NOI (EBITDA or operating cash flow)
}

interface DSCRResult {
  dscr: number;               // Ratio (e.g., 1.32)
  covenantHeadroom?: number;  // Distance from threshold (if provided)
  interpretation: 'healthy' | 'borderline' | 'at-risk'; // Risk flag
  version: string;
}

export function calculateDSCR(inputs: DSCRInputs, covenantThreshold?: number): DSCRResult;

// NPV/IRR calculation
interface CashFlowInputs {
  initialInvestment: number;  // Upfront cost (negative)
  cashFlows: number[];        // Array of annual cash flows
  discountRate: number;       // Discount rate (e.g., 0.10 for 10%)
}

interface NPVResult {
  npv: number;
  irr: number | null;         // null if IRR cannot be computed
  version: string;
}

export function calculateNPV(inputs: CashFlowInputs): NPVResult;
```

**Validation functions** (reject invalid inputs):
```typescript
export function validateLoanInputs(inputs: LoanInputs): ValidationResult {
  const errors: string[] = [];
  if (inputs.principal <= 0) errors.push("Loan amount must be positive");
  if (inputs.annualRate < 0 || inputs.annualRate > 0.5) {
    errors.push("Interest rate must be between 0% and 50%");
  }
  if (inputs.termMonths <= 0 || inputs.termMonths > 600) {
    errors.push("Loan term must be between 1 and 600 months");
  }
  return { valid: errors.length === 0, errors };
}
```

### How Calculators Consume It

Calculators import functions from the library and call them with user inputs:

```typescript
import { calculateAmortization, validateLoanInputs } from '@smartprofit/finance-math';

function BusinessLoanCalculator({ inputs }) {
  // Validate inputs
  const validation = validateLoanInputs(inputs);
  if (!validation.valid) {
    return <ErrorDisplay errors={validation.errors} />;
  }

  // Calculate
  const result = calculateAmortization(inputs);

  // Render results
  return <ResultsTable monthlyPayment={result.monthlyPayment}
                       totalInterest={result.totalInterest}
                       schedule={result.schedule} />;
}
```

### Versioning Approach

**Semantic versioning** (MAJOR.MINOR.PATCH):
- **MAJOR**: Breaking changes to function signatures or formula logic (e.g., change DSCR definition from NOI/Debt Service to EBITDA/Debt Service)
- **MINOR**: New functions added, non-breaking enhancements (e.g., add `calculateIRR` function)
- **PATCH**: Bug fixes, performance improvements, no behavior changes

**Formula-level versioning**:
- Each formula function returns a `version` field in its result (e.g., `"dscr_v1.3.2"`)
- Version ID stored in scenario metadata and export files for audit trail
- Regression tests pin specific formula versions to detect drift

**Upgrade strategy**:
- Calculators pin library version in `package.json`: `"@smartprofit/finance-math": "^1.3.0"` (allow MINOR and PATCH updates, not MAJOR)
- MAJOR version upgrades require explicit calculator updates and regression testing

---

## 2. UI Component Library

### Purpose

The UI Component Library provides reusable React components for calculator interfaces. This ensures:
- **Consistency**: All calculators have the same input field styles, button behaviors, warning displays
- **Accessibility**: WCAG 2.1 AA compliance built into components (keyboard navigation, ARIA labels, screen reader support)
- **Rapid development**: New calculators can be built 50-70% faster by composing existing components

### API/Interface

Components are React function components with TypeScript props:

```typescript
// Input field with validation and tooltip
interface InputFieldProps {
  label: string;
  value: number | string;
  onChange: (value: number | string) => void;
  type: 'currency' | 'percentage' | 'number' | 'text';
  tooltip?: string;
  error?: string;
  placeholder?: string;
  min?: number;
  max?: number;
  required?: boolean;
}

export function InputField(props: InputFieldProps): JSX.Element;

// Result card (displays a key metric)
interface ResultCardProps {
  label: string;
  value: number | string;
  format: 'currency' | 'percentage' | 'number';
  trend?: 'up' | 'down' | 'neutral';  // Optional trend indicator
  tooltip?: string;
  highlighted?: boolean;  // Pro tier metrics highlighted in gold
  proOnly?: boolean;      // Show lock icon + "Upgrade to Pro" if Free tier
}

export function ResultCard(props: ResultCardProps): JSX.Element;

// Warning banner
interface WarningProps {
  severity: 'info' | 'warning' | 'error';
  title: string;
  message: string;
  actionLabel?: string;
  onAction?: () => void;
}

export function Warning(props: WarningProps): JSX.Element;

// Scenario tabs
interface ScenarioTabsProps {
  scenarios: Array<{ id: string; name: string; }>;
  activeScenarioId: string;
  onSwitch: (scenarioId: string) => void;
  onNew: () => void;
  onDelete: (scenarioId: string) => void;
  maxScenarios: number;   // Free tier: 1, Pro tier: 10
  tier: 'free' | 'pro';
}

export function ScenarioTabs(props: ScenarioTabsProps): JSX.Element;
```

**Higher-level composition components**:
```typescript
// Calculator shell (wraps all calculators)
interface CalculatorShellProps {
  title: string;
  children: React.ReactNode;  // Input panel and results panel
  scenarioTabs: React.ReactNode;
  exportButtons: React.ReactNode;
  aiNarrative?: React.ReactNode;  // Shown if AI add-on enabled
}

export function CalculatorShell(props: CalculatorShellProps): JSX.Element;
```

### How Calculators Consume It

Calculators import components and compose them:

```typescript
import {
  CalculatorShell, InputField, ResultCard, Warning, ScenarioTabs
} from '@smartprofit/ui-components';

function BusinessLoanCalculator() {
  const [inputs, setInputs] = useState({ principal: 200000, rate: 0.075, term: 60 });
  const result = calculateAmortization(inputs);

  return (
    <CalculatorShell title="Business Loan + DSCR Calculator"
                     scenarioTabs={<ScenarioTabs scenarios={scenarios} ... />}
                     exportButtons={<ExportButtons ... />}>
      {/* Input Panel */}
      <InputField label="Loan Amount" value={inputs.principal}
                  onChange={v => setInputs({...inputs, principal: v})}
                  type="currency" tooltip="Total amount borrowed" />
      <InputField label="Interest Rate" value={inputs.rate}
                  onChange={v => setInputs({...inputs, rate: v})}
                  type="percentage" tooltip="Annual interest rate" />

      {/* Results Panel */}
      <ResultCard label="Monthly Payment" value={result.monthlyPayment}
                  format="currency" highlighted />
      <ResultCard label="DSCR" value={result.dscr} format="number"
                  proOnly={tier === 'free'} />

      {/* Warnings */}
      {result.dscr < 1.25 && (
        <Warning severity="warning"
                 title="DSCR Below Threshold"
                 message="Your DSCR of {result.dscr} is below typical lender threshold of 1.25" />
      )}
    </CalculatorShell>
  );
}
```

### Versioning Approach

**Semantic versioning** (MAJOR.MINOR.PATCH):
- **MAJOR**: Breaking changes to component props (e.g., rename `onChange` to `onUpdate`, change prop types)
- **MINOR**: New components added, new optional props
- **PATCH**: Bug fixes, style tweaks, accessibility improvements

**Design system versioning**:
- Tailwind config (colors, spacing, fonts) versioned separately: `@smartprofit/design-tokens`
- Major design overhauls (rebrand) trigger MAJOR version bump in both libraries

**Upgrade strategy**:
- Calculators pin UI library version: `"@smartprofit/ui-components": "^2.1.0"`
- MAJOR upgrades coordinated across all calculators (usually once per year)
- Storybook used for component documentation and visual regression testing

---

## 3. Export Module

### Purpose

The Export Module generates PDFs, CSVs, and Excel files from calculation results. This ensures:
- **Consistency**: All exports have the same header/footer, branding, version stamps
- **Quality**: Board-ready PDFs with professional formatting (per Section 1.3)
- **White-label support**: B2B clients can customize branding (logos, colors, disclaimers)

### API/Interface

```typescript
interface ExportRequest {
  calculatorId: string;           // e.g., "business-loan"
  scenarioId: string;             // Scenario UUID
  exportType: 'pdf' | 'csv' | 'excel';
  userId?: string;                // null for anonymous
  tier: 'free' | 'pro' | 'b2b';
  branding?: {                    // B2B white-label branding
    logo?: string;                // URL to logo image
    primaryColor?: string;        // Hex color
    footerDisclaimer?: string;    // Custom disclaimer text
  };
}

interface ExportResult {
  fileUrl: string;                // S3/R2 presigned URL (1-hour expiry)
  fileName: string;               // e.g., "business-loan-scenario-2025-01-15.pdf"
  fileSize: number;               // Bytes
  generatedAt: string;            // ISO 8601 timestamp
  expiresAt: string;              // ISO 8601 timestamp
  watermarked: boolean;           // true for Free tier, false for Pro/B2B
}

export async function generateExport(request: ExportRequest): Promise<ExportResult>;
```

**Sync vs Async**:
- **Sync** (direct API call, < 3 seconds): Single-scenario PDF or CSV, Pro tier users
- **Async** (job queue, > 3 seconds): Multi-scenario exports, large CSVs (>1000 rows), Excel files
  - Returns immediately with `jobId`
  - Client polls `GET /api/exports/jobs/:jobId` until status is `completed`
  - Or WebSocket notification when ready

### How Calculators Consume It

Frontend requests export via API:

```typescript
async function handleExportClick(exportType: 'pdf' | 'csv') {
  const response = await fetch('/api/exports', {
    method: 'POST',
    body: JSON.stringify({
      calculatorId: 'business-loan',
      scenarioId: currentScenarioId,
      exportType,
      tier: userTier,
    }),
  });

  const result = await response.json();

  if (result.fileUrl) {
    // Sync: download immediately
    window.open(result.fileUrl, '_blank');
  } else {
    // Async: poll for completion
    const jobId = result.jobId;
    const pollInterval = setInterval(async () => {
      const status = await fetch(`/api/exports/jobs/${jobId}`);
      const job = await status.json();
      if (job.status === 'completed') {
        clearInterval(pollInterval);
        window.open(job.fileUrl, '_blank');
      }
    }, 2000);  // Poll every 2 seconds
  }
}
```

### Versioning Approach

**Template versioning**:
- PDF templates versioned: `business-loan-template_v2.1.hbs` (Handlebars)
- Template version stored in export metadata (for audit trail)
- Breaking template changes (e.g., remove a section) trigger new template version, not a code deploy

**Module versioning**:
- Export module versioned independently: `"@smartprofit/export-service": "^1.5.0"`
- MINOR version: Add new export types (e.g., Excel), new branding options
- PATCH version: Bug fixes (formatting issues, missing metadata)

---

## 4. Analytics Client

### Purpose

The Analytics Client tracks user behavior and calculator usage for the Business Intelligence Dashboard (Section 1.8) and product analytics. This module ensures:
- **Privacy**: No PII logged (pseudonymous user IDs only, per Section 1.6)
- **Consistency**: All calculators track events in the same format
- **Performance**: Batched event sends (every 10 seconds or 100 events) to avoid blocking API requests

### API/Interface

```typescript
interface AnalyticsEvent {
  event: string;                  // e.g., "calculation_performed", "export_requested"
  userId?: string;                // Pseudonymous UUID (null for anonymous)
  sessionId: string;              // Session UUID
  calculatorId: string;           // e.g., "business-loan"
  timestamp: string;              // ISO 8601 timestamp
  properties?: Record<string, any>; // Event-specific data (non-PII)
}

export function trackEvent(event: string, properties?: Record<string, any>): void;

export function trackCalculation(calculatorId: string, inputsHash: string, latencyMs: number): void;

export function trackExport(calculatorId: string, exportType: 'pdf' | 'csv', tier: string): void;

export function trackConversion(fromTier: string, toTier: string): void;
```

**Example events**:
```typescript
// Calculator loaded
trackEvent('calculator_loaded', { calculatorId: 'business-loan' });

// Calculation performed
trackCalculation('business-loan', 'abc123hash', 142);  // 142ms latency

// Export requested
trackExport('business-loan', 'pdf', 'pro');

// Tier upgrade
trackConversion('free', 'pro');
```

### How Calculators Consume It

Calculators import and call track functions:

```typescript
import { trackEvent, trackCalculation } from '@smartprofit/analytics-client';

function BusinessLoanCalculator() {
  useEffect(() => {
    trackEvent('calculator_loaded', { calculatorId: 'business-loan' });
  }, []);

  function handleCalculate(inputs) {
    const startTime = Date.now();
    const result = calculateAmortization(inputs);
    const latency = Date.now() - startTime;

    trackCalculation('business-loan', hashInputs(inputs), latency);

    return result;
  }
}
```

### Versioning Approach

**Event schema versioning**:
- Event schemas defined in TypeScript: `@smartprofit/analytics-schemas`
- Breaking schema changes (e.g., rename `calculatorId` to `calculator_id`) require MAJOR version bump
- Analytics pipeline (backend) must support multiple schema versions during migration

**Client versioning**:
- Analytics client versioned: `"@smartprofit/analytics-client": "^1.2.0"`
- MINOR version: Add new convenience functions (e.g., `trackAIRequest`)
- PATCH version: Bug fixes, performance improvements

---

## 5. Tier Gate Module

### Purpose

The Tier Gate Module enforces Free/Pro/AI tier access controls and displays upgrade prompts. This ensures:
- **Consistency**: DSCR metrics locked in Free tier across all calculators
- **Upsell UX**: Upgrade prompts shown uniformly (modal vs inline, messaging)
- **Flexibility**: B2B clients can configure tier behavior per tenant

### API/Interface

```typescript
interface TierConfig {
  tier: 'free' | 'pro' | 'ai';
  limits: {
    maxSavedScenarios: number;    // Free: 1, Pro: 10
    maxExportsPerMonth: number;   // Free: 5, Pro: 100
    maxAIRequestsPerMonth: number; // Free: 0, Pro: 0, AI: 50
  };
  features: {
    advancedMetrics: boolean;     // Free: false, Pro: true
    multiScenario: boolean;       // Free: false, Pro: true
    cleanExports: boolean;        // Free: false (watermarked), Pro: true
    aiNarratives: boolean;        // Free: false, Pro: false, AI: true
  };
}

export function useTierConfig(): TierConfig;

export function canAccess(feature: string, tier: TierConfig): boolean;

export function showUpgradePrompt(feature: string, tier: TierConfig): void;
```

**React hook for feature gating**:
```typescript
function useFeatureGate(feature: string) {
  const tierConfig = useTierConfig();
  const hasAccess = canAccess(feature, tierConfig);

  return {
    hasAccess,
    showPrompt: () => showUpgradePrompt(feature, tierConfig),
  };
}
```

### How Calculators Consume It

Calculators use the hook to gate features:

```typescript
import { useFeatureGate } from '@smartprofit/tier-gate';

function BusinessLoanCalculator() {
  const { hasAccess: canSeeDSCR, showPrompt } = useFeatureGate('advancedMetrics');

  return (
    <>
      <ResultCard label="Monthly Payment" value={monthlyPayment} format="currency" />

      {canSeeDSCR ? (
        <ResultCard label="DSCR" value={dscr} format="number" highlighted />
      ) : (
        <LockedMetric label="DSCR" onUpgrade={showPrompt} />
      )}
    </>
  );
}
```

### Versioning Approach

**Feature flags**:
- Tier feature definitions stored in database (`calculator_configs` table) per Section 3.1
- No code deploy required to change tier limits (e.g., increase Pro max scenarios from 10 to 15)
- Feature flag changes logged for audit trail

**Module versioning**:
- Tier gate module: `"@smartprofit/tier-gate": "^1.1.0"`
- MINOR version: Add new feature flags (e.g., `whiteLabel` for B2B)
- PATCH version: Bug fixes, UI tweaks

---

## 6. Calculator Config Schema

### Purpose

The Calculator Config Schema is a JSON structure that defines calculator metadata, inputs, outputs, and tier behavior. This allows:
- **Code-free calculator definitions**: Non-engineers can define simple calculators via JSON config
- **Consistency**: All calculators follow the same config structure
- **Dynamic rendering**: UI components read config to generate input forms and result displays (optional Phase 2+ feature)

### API/Interface

```typescript
interface CalculatorConfig {
  id: string;                     // e.g., "business-loan"
  name: string;                   // Display name
  category: string;               // Per Section 2.1 categories
  version: string;                // Config version (e.g., "1.2.0")
  inputs: Array<{
    id: string;                   // e.g., "principal"
    label: string;                // "Loan Amount"
    type: 'currency' | 'percentage' | 'number' | 'text';
    required: boolean;
    defaultValue?: any;
    min?: number;
    max?: number;
    tooltip?: string;
  }>;
  outputs: Array<{
    id: string;                   // e.g., "dscr"
    label: string;                // "Debt Service Coverage Ratio"
    format: 'currency' | 'percentage' | 'number';
    tier: 'free' | 'pro' | 'ai';  // Which tier can see this output
    highlighted?: boolean;
  }>;
  formulas: {
    [outputId: string]: string;   // Function name in Finance Math Library
  };
}

export function loadCalculatorConfig(calculatorId: string): CalculatorConfig;
```

**Example config** (Business Loan Calculator):
```json
{
  "id": "business-loan",
  "name": "Business Loan + DSCR Calculator",
  "category": "Financing & Lending Intelligence",
  "version": "1.0.0",
  "inputs": [
    {
      "id": "principal",
      "label": "Loan Amount",
      "type": "currency",
      "required": true,
      "min": 1000,
      "tooltip": "Total amount borrowed"
    },
    {
      "id": "rate",
      "label": "Interest Rate",
      "type": "percentage",
      "required": true,
      "min": 0,
      "max": 50,
      "tooltip": "Annual interest rate"
    }
  ],
  "outputs": [
    {
      "id": "monthlyPayment",
      "label": "Monthly Payment",
      "format": "currency",
      "tier": "free",
      "highlighted": true
    },
    {
      "id": "dscr",
      "label": "DSCR",
      "format": "number",
      "tier": "pro",
      "highlighted": true
    }
  ],
  "formulas": {
    "monthlyPayment": "calculateAmortization",
    "dscr": "calculateDSCR"
  }
}
```

### How Calculators Consume It

**Phase 1**: Configs stored as static JSON files, imported by calculators (reference only, not dynamically rendered)

**Phase 2+**: Configs stored in database, UI components dynamically render based on config (low-code calculator builder)

```typescript
// Phase 2+ dynamic rendering (optional)
function DynamicCalculator({ calculatorId }) {
  const config = loadCalculatorConfig(calculatorId);
  const [inputs, setInputs] = useState(getDefaultInputs(config));
  const results = executeFormulas(config, inputs);

  return (
    <CalculatorShell title={config.name}>
      {config.inputs.map(input => (
        <InputField key={input.id} {...input}
                    value={inputs[input.id]}
                    onChange={v => setInputs({...inputs, [input.id]: v})} />
      ))}
      {config.outputs.map(output => (
        <ResultCard key={output.id} {...output} value={results[output.id]} />
      ))}
    </CalculatorShell>
  );
}
```

### Versioning Approach

**Schema versioning**:
- Config schema versioned: `CalculatorConfigV1`, `CalculatorConfigV2`
- Breaking schema changes (e.g., rename `inputs` to `fields`) trigger new schema version
- Config parser supports multiple schema versions during migration

**Per-calculator config versioning**:
- Each calculator config has its own `version` field (e.g., `"1.2.0"`)
- Config version stored in scenario metadata (for audit trail)

---

## Summary

These six shared modules accelerate calculator development, ensure consistency, and enable platform-wide improvements (e.g., update all calculators' PDF templates in one place). Key principles:
- **Versioned APIs**: Semantic versioning with clear upgrade paths
- **TypeScript-first**: Strong typing prevents bugs and improves developer experience
- **Separation of concerns**: Math, UI, exports, analytics, tier gating are independent modules
- **Auditability**: Formula versions, config versions, and export templates are tracked for compliance
