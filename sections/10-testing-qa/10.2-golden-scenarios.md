# 10.2 Golden Scenario Framework

This section defines the golden scenario system for regression testing of calculators. Golden scenarios are predefined test cases with known inputs and expected outputs that ensure formulas remain correct across code changes, deployments, and formula updates.

---

## Golden Scenario Philosophy

**Purpose**: Catch regressions before they reach production

**Key principle**: **Every calculator must have golden scenarios** that verify correctness (per Section 2.2: minimum 2-3 per calculator, recommended 10+ for comprehensive coverage).

**What golden scenarios protect against**:
- Formula changes that break correctness (accidental logic errors)
- Refactoring that changes calculation behavior
- Dependency updates that affect math libraries
- Edge cases that produce incorrect results (NaN, Infinity, negative values)

**When golden scenarios run**:
- Every commit (CI/CD pipeline)
- Before every deployment
- On-demand when investigating bugs

---

## 1. Golden Scenario Requirements (Per Calculator)

### Minimum Requirements

**Each calculator MUST have**:
- **Minimum 2-3 golden scenarios** (required for launch)
- **Recommended 10+ scenarios** (comprehensive coverage, typical + edge cases)

**Each golden scenario MUST include**:

1. **Scenario name and description**
   - Descriptive name (e.g., "Typical SBA Loan - Restaurant")
   - Business context (e.g., "Standard SBA 7(a) loan for restaurant equipment purchase")

2. **Fully specified inputs**
   - All required fields provided
   - Specific numeric values (not ranges or placeholders)
   - Example: `loan_amount: 250000` (not `loan_amount: 200000-300000`)

3. **Expected outputs with tolerances**
   - All key outputs specified
   - Tolerance defined per output (e.g., ±$1 for monthly payment, ±0.01 for DSCR)
   - Rationale for tolerance: Floating-point arithmetic may produce slight variations

4. **Expected warnings** (if any should appear)
   - Warning type (info, warning, critical)
   - Warning message (exact text or contains substring)

**Failure to meet requirements**:
- Calculator cannot be deployed without golden scenarios
- Insufficient coverage (<10 scenarios) flagged in code review

### Scenario Coverage Guidelines

**Typical scenarios** (50-70% of scenarios):
- Common use cases (e.g., "Standard business loan", "Typical cash runway")
- Realistic inputs within normal ranges
- No warnings expected (happy path)

**Edge case scenarios** (20-30% of scenarios):
- Boundary values (e.g., loan amount $1, loan amount $100M)
- Extreme inputs (e.g., 0% interest rate, 50% interest rate)
- Values that trigger warnings (e.g., DSCR <1.25, negative operating income)

**Regression scenarios** (10-20% of scenarios):
- Known bugs that have been fixed (prevent re-introduction)
- Tricky calculations (e.g., negative amortization, balloon payments)
- Historical issues reported by users

### Example Coverage Matrix

**Business Loan + DSCR Calculator** (10 scenarios):
1. Typical SBA Loan - Restaurant ($250k, 7.5%, 10 years) → Monthly payment $2,958
2. Short-term Loan - Equipment ($50k, 9%, 3 years) → Monthly payment $1,589
3. Large Loan - Real Estate ($1M, 6%, 25 years) → Monthly payment $6,443
4. Edge Case: Zero Interest Rate ($100k, 0%, 5 years) → Monthly payment $1,667
5. Edge Case: Maximum Term ($250k, 7.5%, 30 years) → Monthly payment $1,748
6. Warning: Low DSCR (DSCR 1.18) → Warning displayed
7. Warning: Negative Operating Income → Critical warning
8. Edge Case: Minimum Loan Amount ($1) → Monthly payment $0.01
9. Regression: Balloon Payment Calculation (known issue fixed in v1.2)
10. Regression: Rounding Error on Large Loans (known issue fixed in v1.3)

---

## 2. Golden Scenario Structure

### Storage Format

**Location**: `/tests/golden-scenarios/` directory in repository

**File naming convention**: `{calculator_slug}_golden_{scenario_number}.json`

**Examples**:
- `business-loan-dscr_golden_1.json`
- `business-loan-dscr_golden_2.json`
- `cash-runway_golden_1.json`
- `breakeven-margin_golden_1.json`

**Rationale for separate files**:
- Easier to add/remove scenarios (one file per scenario)
- Git history shows which scenario changed
- Parallel test execution (run multiple scenarios concurrently)

### JSON Schema

**Complete structure**:

```json
{
  "calculator_slug": "business-loan-dscr",
  "scenario_name": "Typical SBA Loan - Restaurant",
  "description": "Standard SBA 7(a) loan for restaurant equipment purchase. Loan amount $250k at 7.5% for 10 years.",
  "version": "1.0",
  "created_date": "2025-11-01",
  "updated_date": "2025-11-01",
  "inputs": {
    "loan_amount": 250000,
    "interest_rate": 7.5,
    "term_years": 10,
    "annual_revenue": 1500000,
    "annual_expenses": 1200000
  },
  "expected_outputs": {
    "monthly_payment": {
      "value": 2958.04,
      "tolerance": 1,
      "unit": "USD"
    },
    "total_interest": {
      "value": 104964.80,
      "tolerance": 100,
      "unit": "USD"
    },
    "total_cost": {
      "value": 354964.80,
      "tolerance": 100,
      "unit": "USD"
    },
    "dscr": {
      "value": 1.42,
      "tolerance": 0.01,
      "unit": "ratio"
    }
  },
  "expected_warnings": [
    {
      "type": "info",
      "code": "DSCR_ABOVE_MINIMUM",
      "message_contains": "DSCR is above typical lender minimum"
    }
  ],
  "tags": ["typical", "sba", "restaurant"],
  "notes": "This is a reference scenario based on actual SBA loan data. Used as primary smoke test."
}
```

**Field descriptions**:

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| calculator_slug | string | Yes | Calculator identifier (matches calculator route) |
| scenario_name | string | Yes | Human-readable name for scenario |
| description | string | Yes | Business context and purpose |
| version | string | Yes | Scenario version (update when expected outputs change) |
| created_date | string | Yes | ISO date when scenario was created |
| updated_date | string | Yes | ISO date when scenario was last updated |
| inputs | object | Yes | All calculator inputs (key-value pairs) |
| expected_outputs | object | Yes | Expected calculation results with tolerances |
| expected_warnings | array | No | Warnings that should appear (empty array if none) |
| tags | array | No | Tags for filtering (e.g., "typical", "edge_case", "regression") |
| notes | string | No | Additional context or rationale |

**Output structure** (each output has):
- `value`: Expected numeric result
- `tolerance`: Acceptable deviation (e.g., ±1 for monthly payment)
- `unit`: Unit of measurement (USD, ratio, percentage, days)

**Warning structure** (each warning has):
- `type`: Warning severity (info, warning, critical)
- `code`: Warning code (e.g., "DSCR_ABOVE_MINIMUM", "NEGATIVE_OPERATING_INCOME")
- `message_contains`: Substring that must appear in warning message (not exact match, allows for wording changes)

### Example Scenarios

**Example 1: Typical SBA Loan**

```json
{
  "calculator_slug": "business-loan-dscr",
  "scenario_name": "Typical SBA Loan - Restaurant",
  "description": "Standard SBA 7(a) loan for restaurant equipment purchase",
  "version": "1.0",
  "created_date": "2025-11-01",
  "updated_date": "2025-11-01",
  "inputs": {
    "loan_amount": 250000,
    "interest_rate": 7.5,
    "term_years": 10,
    "annual_revenue": 1500000,
    "annual_expenses": 1200000
  },
  "expected_outputs": {
    "monthly_payment": { "value": 2958.04, "tolerance": 1, "unit": "USD" },
    "total_interest": { "value": 104964.80, "tolerance": 100, "unit": "USD" },
    "dscr": { "value": 1.42, "tolerance": 0.01, "unit": "ratio" }
  },
  "expected_warnings": [],
  "tags": ["typical", "sba"]
}
```

**Example 2: Edge Case - Low DSCR**

```json
{
  "calculator_slug": "business-loan-dscr",
  "scenario_name": "Edge Case - Low DSCR",
  "description": "Loan with DSCR below typical lender minimum (1.25), should trigger warning",
  "version": "1.0",
  "created_date": "2025-11-01",
  "updated_date": "2025-11-01",
  "inputs": {
    "loan_amount": 250000,
    "interest_rate": 7.5,
    "term_years": 10,
    "annual_revenue": 1000000,
    "annual_expenses": 900000
  },
  "expected_outputs": {
    "monthly_payment": { "value": 2958.04, "tolerance": 1, "unit": "USD" },
    "dscr": { "value": 1.18, "tolerance": 0.01, "unit": "ratio" }
  },
  "expected_warnings": [
    {
      "type": "warning",
      "code": "DSCR_BELOW_MINIMUM",
      "message_contains": "DSCR is below typical lender minimum of 1.25"
    }
  ],
  "tags": ["edge_case", "warning"]
}
```

**Example 3: Cash Runway - Negative Burn**

```json
{
  "calculator_slug": "cash-runway",
  "scenario_name": "Profitable Business - Negative Burn",
  "description": "Business with positive cash flow (revenue > expenses), runway should be infinite",
  "version": "1.0",
  "created_date": "2025-11-01",
  "updated_date": "2025-11-01",
  "inputs": {
    "current_cash": 100000,
    "monthly_revenue": 50000,
    "monthly_expenses": 40000
  },
  "expected_outputs": {
    "burn_rate": { "value": -10000, "tolerance": 1, "unit": "USD" },
    "runway_months": { "value": Infinity, "tolerance": 0, "unit": "months" }
  },
  "expected_warnings": [
    {
      "type": "info",
      "code": "PROFITABLE",
      "message_contains": "Business is profitable"
    }
  ],
  "tags": ["edge_case", "profitable"]
}
```

---

## 3. Regression Testing Policy

### When to Run Golden Scenarios

**Automated (CI/CD pipeline)**:
- **Every commit**: Run all golden scenarios for affected calculators
- **Every pull request**: Run full test suite (all calculators)
- **Every deployment**: Run full test suite (gate for production release)

**Manual (on-demand)**:
- **Investigating bug**: Run scenarios for specific calculator
- **Formula update**: Run scenarios before and after change (compare outputs)
- **Performance testing**: Run scenarios under load (verify correctness at scale)

### Pass/Fail Criteria

**PASS**: All outputs within tolerance

```
Expected: monthly_payment = 2958.04 ± 1
Actual:   monthly_payment = 2958.03
Result:   PASS (within tolerance)
```

**FAIL**: Any output outside tolerance

```
Expected: monthly_payment = 2958.04 ± 1
Actual:   monthly_payment = 2960.50
Result:   FAIL (difference: $2.46, exceeds tolerance of $1)
```

**Action on FAIL**:
- Block merge (CI/CD fails)
- Engineer investigates: Is this a bug or intentional change?
- If bug: Fix code, re-run tests
- If intentional: Update golden scenario (see below)

**FAIL**: Missing expected warning

```
Expected: Warning "DSCR is below typical lender minimum"
Actual:   No warnings
Result:   FAIL (warning not displayed)
```

**WARN**: Unexpected warning (review required, may or may not block)

```
Expected: No warnings
Actual:   Warning "High interest rate detected"
Result:   WARN (unexpected warning appeared)
```

**Action on unexpected warning**:
- Review by engineer: Is this a new warning that should be expected?
- If valid: Update golden scenario to expect warning
- If invalid: Fix code to remove spurious warning

### On Intentional Output Changes

**When expected outputs change** (e.g., formula improvement, bug fix):

1. **Update golden scenario file**
   - Change `expected_outputs` to reflect new correct values
   - Increment `version` (e.g., "1.0" → "1.1")
   - Update `updated_date` to current date
   - Add `notes` explaining why outputs changed

2. **Document reason in commit message**
   ```
   Update DSCR golden scenario for improved precision

   Changed expected monthly payment from $2,958 to $2,958.04 due to
   improved rounding in amortization formula (v1.2). This is intentional
   and provides more accurate results.

   Closes #123
   ```

3. **Get approval from product manager**
   - Pull request requires PM approval if golden scenarios change
   - PM verifies change is intentional and correct
   - Prevents accidental formula changes from slipping through

**Example of intentional change**:

```diff
{
  "scenario_name": "Typical SBA Loan - Restaurant",
- "version": "1.0",
+ "version": "1.1",
- "updated_date": "2025-11-01",
+ "updated_date": "2025-11-15",
  "expected_outputs": {
    "monthly_payment": {
-     "value": 2958,
+     "value": 2958.04,
      "tolerance": 1
    }
  },
+ "notes": "Updated to reflect improved rounding precision in v1.2"
}
```

---

## 4. Golden Scenario Repository

### Version Control

**Storage**: Git repository (same repo as application code)

**Directory structure**:
```
/tests/
  /golden-scenarios/
    business-loan-dscr_golden_1.json
    business-loan-dscr_golden_2.json
    business-loan-dscr_golden_3.json
    cash-runway_golden_1.json
    cash-runway_golden_2.json
    breakeven-margin_golden_1.json
    ...
  /golden-scenario-runner.ts  (Test execution code)
  /golden-scenario-schema.json  (JSON schema for validation)
```

**Benefits of version control**:
- **History**: See when scenarios were added/changed
- **Blame**: Identify who changed expected outputs
- **Diff**: Compare scenarios across branches (what changed in this PR?)
- **Rollback**: Revert to previous version if needed

### How to Add New Scenarios

**Process**:

1. **Create JSON file** following structure above
   - Name: `{calculator_slug}_golden_{next_number}.json`
   - Fill in all required fields

2. **Run scenario manually, verify outputs are correct**
   - Use calculator UI or API to execute with specified inputs
   - Record actual outputs (monthly payment, DSCR, etc.)
   - Verify outputs match expectations (use external tools if needed, e.g., Excel for amortization)

3. **Add to automated test suite**
   - Test runner automatically discovers new JSON files in `/tests/golden-scenarios/`
   - No code changes needed (data-driven testing)

4. **Document in calculator PDR** (Section 11)
   - List golden scenarios in calculator-specific PDR
   - Explain coverage (typical, edge cases, regression)

**Example manual verification**:
```bash
# Run calculator with inputs from golden scenario
curl -X POST https://api.example.com/api/calculate \
  -H "Content-Type: application/json" \
  -d '{
    "calculator_slug": "business-loan-dscr",
    "inputs": {
      "loan_amount": 250000,
      "interest_rate": 7.5,
      "term_years": 10
    }
  }'

# Response:
# {
#   "outputs": {
#     "monthly_payment": 2958.04,
#     "total_interest": 104964.80,
#     "dscr": 1.42
#   },
#   "version": "v1"
# }

# Verify outputs match expected values in golden scenario ✓
```

### Automated Execution

**Test runner implementation**:

```typescript
// Golden scenario test runner
describe('Golden Scenarios', () => {
  const scenarioFiles = fs.readdirSync('./tests/golden-scenarios/')
    .filter(file => file.endsWith('.json'));

  scenarioFiles.forEach(file => {
    const scenario = JSON.parse(fs.readFileSync(`./tests/golden-scenarios/${file}`, 'utf8'));

    test(`${scenario.calculator_slug}: ${scenario.scenario_name}`, async () => {
      // Execute calculation
      const result = await calculateFormula(scenario.calculator_slug, scenario.inputs);

      // Check each expected output
      Object.keys(scenario.expected_outputs).forEach(key => {
        const expected = scenario.expected_outputs[key];
        const actual = result.outputs[key];

        // Verify within tolerance
        expect(actual).toBeCloseTo(expected.value, expected.tolerance);
      });

      // Check expected warnings
      scenario.expected_warnings.forEach(expectedWarning => {
        const matchingWarning = result.warnings.find(w =>
          w.code === expectedWarning.code &&
          w.message.includes(expectedWarning.message_contains)
        );
        expect(matchingWarning).toBeDefined();
      });

      // Warn on unexpected warnings
      if (result.warnings.length > scenario.expected_warnings.length) {
        console.warn(`Unexpected warnings in ${scenario.scenario_name}:`, result.warnings);
      }
    });
  });
});
```

**CI/CD integration**:

```yaml
# GitHub Actions workflow
name: Golden Scenarios

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm install
      - run: npm run test:golden-scenarios
      - if: failure()
        run: |
          echo "Golden scenarios failed!"
          echo "Review test output and update scenarios if change is intentional."
          exit 1
```

**Test output example**:

```
Running golden scenarios...

✓ business-loan-dscr: Typical SBA Loan - Restaurant (142ms)
✓ business-loan-dscr: Short-term Loan - Equipment (98ms)
✓ business-loan-dscr: Edge Case - Zero Interest Rate (105ms)
✗ business-loan-dscr: Edge Case - Low DSCR (89ms)
  Expected DSCR warning not displayed
  Expected: "DSCR is below typical lender minimum"
  Actual warnings: []

✓ cash-runway: Typical Startup - Positive Burn (76ms)
✓ cash-runway: Profitable Business - Negative Burn (71ms)

Test Suites: 1 failed, 5 passed, 6 total
Tests:       1 failed, 5 passed, 6 total

FAIL: Golden scenarios failed. Review and fix before merging.
```

---

## Summary

The golden scenario framework provides regression safety for all calculators:

**Requirements**:
- Minimum 2-3 golden scenarios per calculator (required for launch)
- Recommended 10+ scenarios (comprehensive coverage)
- Each scenario: name, description, inputs, expected outputs with tolerances, expected warnings

**Structure**:
- JSON files in `/tests/golden-scenarios/`
- File naming: `{calculator_slug}_golden_{number}.json`
- Version controlled in Git

**Regression testing**:
- Run automatically on every commit (CI/CD)
- PASS if all outputs within tolerance
- FAIL if any output outside tolerance (blocks merge)
- Intentional changes require updating scenario + PM approval

**Automated execution**:
- Test runner discovers JSON files automatically
- Compares actual vs expected outputs
- Reports tolerance violations
- Blocks merge if failures

Golden scenarios ensure **formula correctness** and **prevent regressions** across the entire calculator suite.
