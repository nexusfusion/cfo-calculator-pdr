# 10.3 Release Process

This section defines the versioning strategy, rollout procedures, release checklists, and post-release monitoring for the CFO Business Intelligence Calculator Suite. A disciplined release process ensures quality, minimizes risk, and enables rapid rollback if issues arise.

---

## Release Philosophy

**Goals**:
- **Quality**: Only deploy code that passes all tests and meets quality standards
- **Safety**: Gradual rollout with monitoring, fast rollback if needed
- **Transparency**: Clear versioning, documented changes, user communication

**Release frequency**:
- **Patch releases**: Weekly (bug fixes, minor improvements)
- **Minor releases**: Bi-weekly to monthly (new features, new calculators)
- **Major releases**: Quarterly (breaking changes, major feature additions)

---

## 1. Versioning Strategy

### Suite Version

**Format**: `Major.Minor.Patch` (Semantic Versioning)

**Examples**: `1.0.0`, `1.2.3`, `2.0.0`

**Version increments**:

| Change Type | Version Increment | Examples |
|-------------|-------------------|----------|
| **Major** | Breaking changes, major feature additions | API version change (v1 → v2), formula changes that break backward compatibility, UI redesign |
| **Minor** | New calculators, new features (backward compatible) | New calculator added, new AI feature, new export format, Pro tier feature additions |
| **Patch** | Bug fixes, performance improvements, minor tweaks | Formula bug fix, UI bug fix, performance optimization, tooltip text correction |

**Version location**:
- Package.json: `"version": "1.2.3"`
- API response: `GET /api/version` → `{ "version": "1.2.3" }`
- UI footer: "CFO Calculator Suite v1.2.3"

**Example version history**:
```
1.0.0 - Initial launch (M1: 2 calculators)
1.1.0 - Added 6 more calculators (M2: 8 calculators total)
1.1.1 - Bug fix: DSCR rounding error
1.2.0 - Added AI narratives for all calculators
1.2.1 - Performance optimization: caching layer
2.0.0 - API v2 (breaking change: new authentication)
```

### Calculator Version

**Format**: `Major.Minor.Patch` (independent per calculator)

**Stored in**: Calculator configuration file

**Example**:
```typescript
// /src/calculators/business-loan-dscr/config.ts
export const calculatorConfig = {
  slug: 'business-loan-dscr',
  name: 'Business Loan + DSCR Calculator',
  version: '2.1.0',
  formulaVersion: 'v1.3.2',
};
```

**Version increments**:
- **Major**: Formula change (breaking, produces different results)
- **Minor**: New feature (e.g., new output metric, new warning)
- **Patch**: Bug fix (corrects incorrect result)

**Why separate calculator versions**:
- Calculators evolve independently (DSCR may update, Runway unchanged)
- Users can see which calculator version generated their export
- Debugging: "This PDF was generated with DSCR v2.1.0, but current is v2.2.0"

### Formula Library Version

**Format**: `Major.Minor.Patch` (suite-wide formula library)

**Stored in**: `/src/formulas/version.ts`

**Example**:
```typescript
export const FORMULA_LIBRARY_VERSION = 'v1.3.2';
```

**Version increments**:
- **Major**: Significant formula methodology change (e.g., switch from simple interest to compound interest)
- **Minor**: New formula added, formula improvement (better accuracy)
- **Patch**: Bug fix in existing formula

**Why separate formula version**:
- Track formula changes independently from feature changes
- Exports stamped with formula version (reproducibility)
- Golden scenarios reference specific formula versions

### Version Stamping in Exports

**PDF footer**:
```
Generated by CFO Calculator Suite v1.2.3 | Calculator: business-loan-dscr v2.1.0 | Formulas: v1.3.2 | 2025-11-18
```

**CSV header row**:
```csv
# Generated by CFO Calculator Suite v1.2.3, business-loan-dscr v2.1.0, Formulas v1.3.2, 2025-11-18
```

**Excel metadata** (document properties):
```
Title: Business Loan DSCR Calculator Results
Subject: Generated by CFO Calculator Suite v1.2.3
Comments: Calculator v2.1.0, Formulas v1.3.2, Generated 2025-11-18
```

**Purpose of version stamping**:
- **Reproducibility**: User can verify which version generated their export
- **Debugging**: Support can identify if issue is due to old version
- **Compliance**: Audit trail for regulatory purposes

---

## 2. Rollout Strategy

### Feature Flags for Gradual Rollout

**Purpose**: Roll out new features gradually to minimize risk

**Implementation**: Feature flag service (e.g., LaunchDarkly, custom Redis-based)

**Rollout stages**:

1. **0% (disabled)**: Feature code deployed but disabled for all users
2. **10% (canary)**: Enable for 10% of users, monitor for errors
3. **50% (half)**: Enable for 50% of users, monitor conversion/engagement
4. **100% (full)**: Enable for all users (remove flag after stabilization)

**Example: New calculator rollout**

```typescript
// Feature flag check
if (featureFlags.isEnabled('calc_equipment_lease', userId)) {
  // Show Equipment Lease calculator in navigation
  calculators.push({
    slug: 'equipment-lease-vs-buy',
    name: 'Equipment Lease vs Buy',
  });
}
```

**Rollout schedule**:
```
Day 1: Deploy code (flag at 0%)
Day 2: Enable for internal users (QA, dogfooding)
Day 3: Enable for 10% of users (monitor error rate, performance)
Day 5: If stable, increase to 50%
Day 7: If stable, increase to 100%
Day 14: Remove feature flag (cleanup)
```

**Rollback**: If error rate >5% at any stage, disable flag immediately (instant rollback to 0%).

### Canary Deployments

**Purpose**: Test new version with small subset of users before full rollout

**Canary process**:

1. **Deploy to staging** (internal testing environment)
   - Full test suite runs in staging
   - Manual QA by internal team (2-4 hours)
   - Performance testing (load test with production-like traffic)

2. **Deploy to canary tenants** (5-10 B2B early access partners)
   - B2B customers who opted into early access program
   - Monitor error rates, performance metrics for 24-48 hours
   - Collect feedback (bugs, UX issues, feature requests)

3. **Monitor for 24-48 hours**
   - Error rate <2% (below baseline)
   - p95 latency within SLAs
   - No critical bugs reported

4. **Roll out to all users**
   - If canary stable, deploy to production (all users)
   - Continue monitoring for first 24 hours

**Canary infrastructure** (two production environments):
- **Canary environment**: 5-10% of traffic
- **Production environment**: 90-95% of traffic
- Load balancer routes traffic based on user_id hash

**Example routing**:
```typescript
function shouldRouteToCanary(userId: string): boolean {
  const hash = hashUserId(userId);
  return hash % 100 < 10; // 10% of users go to canary
}
```

### Rollback Plan

**When to rollback**:
- Error rate >5% for 5 minutes (critical)
- p95 latency >2× SLA target (e.g., >300ms for calculations)
- Critical bug discovered (data loss, payment failures, security issue)
- User-reported issues exceed threshold (>10 support tickets in 1 hour)

**Rollback methods**:

1. **Feature flag disable** (instant, <1 minute)
   - Set feature flag to 0% (disables new feature for all users)
   - No deployment needed (flag change propagates in seconds)
   - Use for: New calculators, new UI features, new AI prompts

2. **Database migration rollback** (5-10 minutes)
   - Run down migration (reverse schema changes)
   - Only if schema change is reversible (not all are)
   - Use for: Table additions, column additions (drops are not reversible)

3. **Code deployment rollback** (10-15 minutes)
   - Deploy previous Git tag (e.g., v1.2.2 if v1.2.3 has issues)
   - Automated via CI/CD (one-click rollback)
   - Use for: Critical bugs in formulas, API endpoints, payment processing

**Automatic rollback trigger**:
```typescript
// Monitoring alert
if (errorRate > 0.05 && duration > 300) { // 5% error rate for 5 minutes
  alert('Critical error rate, triggering automatic rollback');
  rollbackToVersion(previousVersion);
  notifyOnCall('Automatic rollback triggered due to high error rate');
}
```

**Manual rollback procedure**:
```bash
# 1. Identify previous stable version
git tag --sort=-creatordate | head -n 2
# Output: v1.2.3 (current, broken), v1.2.2 (previous, stable)

# 2. Trigger rollback deployment
./deploy.sh rollback v1.2.2

# 3. Verify rollback successful
curl https://api.example.com/api/version
# Output: { "version": "1.2.2" }

# 4. Monitor error rate (should drop to <2%)
```

---

## 3. Release Checklist

### Pre-Release Checklist

**Before deployment**, all items must be checked:

- [ ] **All unit tests passing** (100% for formulas, 80% for UI)
  - Run: `npm run test:unit`
  - CI/CD status: Green

- [ ] **All golden scenarios passing** (within tolerance)
  - Run: `npm run test:golden-scenarios`
  - Zero failures (any failure blocks release)

- [ ] **Integration tests passing**
  - Run: `npm run test:integration`
  - API endpoints, database operations, tier gating, exports

- [ ] **End-to-end tests passing**
  - Run: `npm run test:e2e`
  - Free tier workflow, Pro tier workflow, upgrade workflow
  - Cross-browser: Chrome, Safari, Firefox, Edge

- [ ] **Performance benchmarks met**
  - p95 calculation latency <150ms (Section 1.6 SLA)
  - p95 export generation time <3 seconds
  - Load test passed (100 concurrent users, error rate <1%)

- [ ] **Security review completed** (if code touches sensitive areas)
  - Authentication/authorization changes → Security review required
  - Payment processing changes → Security review required
  - Data handling changes (PII, exports) → Security review required
  - Use checklist: OWASP Top 10, SQL injection, XSS, CSRF

- [ ] **Documentation updated**
  - Calculator PDRs updated (if calculator changed)
  - API documentation updated (if API changed)
  - Changelog drafted (user-facing changes)
  - Internal release notes drafted (for team)

- [ ] **Version numbers incremented**
  - Suite version in package.json
  - Calculator version in config (if calculator changed)
  - Formula library version (if formula changed)
  - Git tag created (e.g., `v1.2.3`)

**Approval**:
- Pull request approved by: 1 engineer + 1 product manager (if feature change)
- Security review approved by: Security engineer (if applicable)

### Post-Release Checklist

**After deployment**, verify deployment successful:

- [ ] **Monitor error rate for first 1 hour** (<1% threshold)
  - Dashboard: Datadog/New Relic error rate panel
  - Alert threshold: >2% error rate triggers Slack notification
  - If >5% for 5 minutes → Automatic rollback

- [ ] **Check performance metrics** (p95 latency within SLAs)
  - Calculation latency: <150ms (target)
  - Export generation: <3s (target)
  - AI request latency: <3s (target)

- [ ] **Verify new features accessible to correct tiers**
  - Test as Free user: Cannot access Pro features (upgrade prompt shown)
  - Test as Pro user: Can access Pro features (scenarios, advanced metrics, clean exports)
  - Test as AI user: Can access AI features (narratives, suggestions)

- [ ] **Test one complete user workflow** (smoke test)
  - Free user: View calculator → Enter inputs → See results → Attempt export (blocked)
  - Pro user: Create scenario → Export PDF → Verify clean export
  - AI user: Request AI narrative → Verify response within 3 seconds

- [ ] **Update internal team on Slack/email with release notes**
  - Slack message: "#releases channel: v1.2.3 deployed successfully. New features: [list]. Known issues: [list]."
  - Email: Send to engineering team, product team, support team

- [ ] **Publish changelog to users** (in-app banner, blog post for major releases)
  - Minor release: In-app banner ("New calculator available: Equipment Lease vs Buy")
  - Major release: Blog post + email to Pro/AI users ("CFO Calculator Suite v2.0: API v2, new features")

**Monitoring duration**:
- **First 1 hour**: Active monitoring (engineer on standby)
- **First 24 hours**: Passive monitoring (alerts enabled, no active watching)
- **First week**: Daily metrics review (error rate, conversion rate, feedback)

---

## 4. Post-Release Monitoring

### First 24 Hours

**Error rate monitoring** (every hour):
- Check Datadog/New Relic dashboard
- Compare to baseline (pre-release error rate)
- Action: If error rate >2× baseline, investigate immediately

**Performance metrics** (every 2 hours):
- p95 calculation latency (target: <150ms)
- p95 export generation time (target: <3s)
- p95 AI request latency (target: <3s)
- Action: If p95 >2× target, investigate performance regression

**User feedback channels** (monitored continuously):
- Support tickets: Check Zendesk/Intercom for new tickets
- In-app feedback: Check feedback widget for negative feedback
- Social media: Monitor Twitter, Reddit for mentions
- Action: If >5 similar complaints, triage as bug (may be P1 or P2)

**Example monitoring dashboard**:
```
Post-Release Monitoring (v1.2.3)
┌─────────────────────────────────────┐
│ Error Rate:         1.2% (baseline: 1.0%)  ✓
│ p95 Calc Latency:   142ms (target: <150ms) ✓
│ p95 Export Time:    2.8s (target: <3s)     ✓
│ Support Tickets:    2 (last hour)          ✓
│ User Feedback:      1 negative (last hour) ✓
└─────────────────────────────────────┘
Status: HEALTHY
```

### First Week

**Daily review of key metrics**:
- **Error rate**: Trending down or stable?
- **Conversion rate**: Free → Pro conversions stable or improved?
- **AI usage**: AI requests per user stable (if AI feature released)?
- **Calculator usage**: New calculator getting traffic (if new calc released)?

**Identify unexpected behavior**:
- Calculations taking longer than expected (performance regression)
- Exports failing for specific calculators (export bug)
- Upgrade prompts not triggering (tier gating bug)
- AI narratives timing out frequently (AI API issue)

**Plan hotfix if critical issues found**:
- **Critical (P0)**: Hotfix within 4 hours (e.g., all exports failing)
- **High (P1)**: Hotfix within 24 hours (e.g., one calculator broken)
- **Medium (P2)**: Fix in next release (e.g., tooltip text incorrect)

**Example weekly review**:
```
Week 1 Post-Release Review (v1.2.3)
─────────────────────────────────────
Deployed: 2025-11-18
Status: Stable

Metrics:
- Error rate: 1.1% (baseline: 1.0%) ✓ Acceptable
- p95 calc latency: 145ms (target: <150ms) ✓ On target
- Conversion rate: 3.8% (baseline: 3.5%) ✓ Improved
- AI usage: 28 requests/user (expected: 30) ✓ Normal

Issues:
- 3 support tickets about Equipment Lease calculator (new)
  - Issue: Unclear tooltip text for "residual value"
  - Priority: P3 (low)
  - Action: Update tooltip text in next release

- 1 performance regression in Valuation calculator
  - Issue: DCF calculation slower (p95 420ms, was 350ms)
  - Priority: P2 (medium)
  - Action: Investigate caching, fix in next release

Next Steps:
- Continue monitoring for Week 2
- Plan hotfix for P2 performance issue
- Add P3 tooltip fix to backlog
```

### Success Criteria

**Release is considered successful if**:

1. **Error rate <2%** (below or equal to baseline)
   - Measured: First 24 hours
   - Baseline: Pre-release error rate (typically 1-1.5%)

2. **p95 latency within SLAs**
   - Calculation: <150ms
   - Export: <3s
   - AI: <3s

3. **No critical bugs reported**
   - Zero P0 bugs (system down, data loss, payment failures)
   - <3 P1 bugs (major features broken)

4. **Conversion rate stable or improved** (for releases affecting upgrade flow)
   - Free → Pro conversion: ≥ baseline (typically 3-5%)
   - If new feature intended to improve conversion, expect 10-20% lift

**If success criteria not met**:
- Investigate root cause (code issue, infrastructure issue, user confusion?)
- Plan hotfix (if critical) or include fix in next release (if minor)
- Document lessons learned (post-mortem if critical issue)

---

## Summary

The release process for the CFO Business Intelligence Calculator Suite includes:

**Versioning**:
- Suite version: Major.Minor.Patch (Semantic Versioning)
- Calculator version: Independent per calculator
- Formula library version: Suite-wide formula versioning
- Version stamping in exports (PDF footer, CSV header)

**Rollout strategy**:
- Feature flags: Gradual rollout (0% → 10% → 50% → 100%)
- Canary deployments: Test with 5-10 B2B early access partners for 24-48 hours
- Rollback plan: Feature flag disable (<1 min), code rollback (10-15 min), automatic trigger if error rate >5%

**Release checklists**:
- Pre-release: Tests passing, performance benchmarks met, security review, documentation updated
- Post-release: Monitor error rate, verify features accessible, test workflows, publish changelog

**Post-release monitoring**:
- First 24 hours: Hourly error rate monitoring, bi-hourly performance checks
- First week: Daily metrics review, identify unexpected behavior, plan hotfixes
- Success criteria: Error rate <2%, p95 latency within SLAs, no critical bugs, conversion stable or improved

**Release frequency**: Weekly (patches), bi-weekly to monthly (minor), quarterly (major).
