# 7.2 Standard Events for All Calculators

This section defines the 12 core analytics events that every calculator in the CFO Business Intelligence Calculator Suite must track. These events enable funnel analysis, conversion tracking, feature adoption monitoring, and performance measurement across the entire platform.

---

## Event Overview

**Purpose**: Standardized event tracking across all calculators ensures:
- Consistent funnel analysis (views → calculations → exports)
- Cross-calculator comparison (which calculators drive conversions)
- Tier-specific usage insights (Free vs Pro behavior)
- Performance benchmarking (latency, error rates)

**Implementation requirement**: All 12 events are **mandatory** for every calculator. Events fire server-side (not client-only) to prevent data loss from ad blockers or client failures.

---

## 1. calculator_viewed

**When fired**: Calculator page loads and initial render completes

**Trigger condition**:
- User navigates to calculator URL (e.g., `/calculators/business-loan-dscr`)
- Page successfully loads with inputs visible
- Fires once per page load (not on input changes or recalculations)

**Required properties**:
```json
{
  "event_name": "calculator_viewed",
  "properties": {
    "session_id": "550e8400-e29b-41d4-a716-446655440000",
    "user_id": null,
    "tier": "free",
    "calculator_slug": "business-loan-dscr",
    "scenario_count": 0,
    "timestamp": "2025-11-17T21:30:00Z",
    "referrer": "google",
    "ab_test_variant": "new_ui_v2"
  }
}
```

**Optional properties**:
- `referrer`: Traffic source (organic, google, paid_search, affiliate_sba_lender, direct)
- `ab_test_variant`: A/B test variant if user is in test

**Purpose and usage**:
- **Funnel entry point**: All calculator funnels start with this event
- **Traffic source analysis**: Identify which channels drive calculator usage
- **A/B test segmentation**: Compare new UI vs old UI performance
- **Session start tracking**: First event in calculator session

**Analytics queries**:
- Total views per calculator per day
- View-to-calculation conversion rate (calculator_viewed → calculator_calculated)
- Referrer breakdown (which sources drive most traffic)

---

## 2. calculator_calculated

**When fired**: User triggers calculation and results are displayed

**Trigger condition**:
- User changes any input field, causing auto-calculation (debounced 500ms)
- Or user clicks "Calculate" button (if no auto-calculation)
- Results successfully computed and rendered

**Required properties**:
```json
{
  "event_name": "calculator_calculated",
  "properties": {
    "session_id": "550e8400-e29b-41d4-a716-446655440000",
    "user_id": null,
    "tier": "free",
    "calculator_slug": "business-loan-dscr",
    "scenario_count": 1,
    "timestamp": "2025-11-17T21:31:15Z",
    "response_time_ms": 142
  }
}
```

**Optional properties**:
- `response_time_ms`: Calculation latency (server-side computation time)

**Purpose and usage**:
- **Core engagement metric**: Indicates user performed a calculation (primary action)
- **Calculation frequency**: How many calculations per session (high engagement = multiple iterations)
- **Performance tracking**: Latency per calculator (identify slow calculators)
- **Tier segmentation**: Free vs Pro calculation patterns

**Analytics queries**:
- Calculations per calculator per day
- Average calculations per session (example: Free tier 3.2, Pro tier 7.5)
- p95 calculation latency per calculator (target: < 150ms)

**Important**: Do not fire this event on page load with default values. Only fire when user changes inputs.

---

## 3. scenario_created

**When fired**: User creates a new scenario (Pro tier feature)

**Trigger condition**:
- User clicks "Add Scenario" button
- New scenario successfully saved to database
- Pro tier or higher (Free tier triggers upgrade_prompt_shown instead)

**Required properties**:
```json
{
  "event_name": "scenario_created",
  "properties": {
    "session_id": "550e8400-e29b-41d4-a716-446655440000",
    "user_id": "e8f5a3c2-1234-5678-9abc-def012345678",
    "tier": "pro",
    "calculator_slug": "business-loan-dscr",
    "scenario_count": 2,
    "timestamp": "2025-11-17T21:32:30Z"
  }
}
```

**Purpose and usage**:
- **Pro feature adoption**: How many Pro users use multi-scenario comparison
- **Calculator-specific behavior**: Which calculators drive scenario creation (example: valuation calculators may have higher scenario usage than simple loan calculators)
- **Tier value validation**: Justify Pro tier pricing with feature usage

**Analytics queries**:
- Percentage of Pro users who create 2+ scenarios
- Average scenarios per Pro user per calculator
- Scenario creation rate over time (increasing = good Pro adoption)

**Free tier handling**: If Free user clicks "Add Scenario", fire `upgrade_prompt_shown` instead with `trigger_reason: "add_scenario"`.

---

## 4. scenario_deleted

**When fired**: User deletes a scenario

**Trigger condition**:
- User clicks delete icon on scenario tab
- Confirms deletion (if confirmation prompt shown)
- Scenario successfully removed from database

**Required properties**:
```json
{
  "event_name": "scenario_deleted",
  "properties": {
    "session_id": "550e8400-e29b-41d4-a716-446655440000",
    "user_id": "e8f5a3c2-1234-5678-9abc-def012345678",
    "tier": "pro",
    "calculator_slug": "business-loan-dscr",
    "scenario_count": 1,
    "timestamp": "2025-11-17T21:35:00Z"
  }
}
```

**Purpose and usage**:
- **Scenario lifecycle tracking**: How long scenarios survive before deletion
- **User cleanup behavior**: Do users delete old scenarios or accumulate them?
- **Data retention optimization**: Inform retention policies (if users delete quickly, auto-expiry less needed)

**Analytics queries**:
- Average time from scenario_created to scenario_deleted (scenario lifespan)
- Deletion rate per calculator

---

## 5. export_requested

**When fired**: User clicks export button to generate report

**Trigger condition**:
- User clicks "Export" or "Download Report" button
- Before export generation starts (request initiated)
- All tiers (Free gets watermarked, Pro gets clean)

**Required properties**:
```json
{
  "event_name": "export_requested",
  "properties": {
    "session_id": "550e8400-e29b-41d4-a716-446655440000",
    "user_id": null,
    "tier": "free",
    "calculator_slug": "business-loan-dscr",
    "scenario_count": 1,
    "export_format": "pdf",
    "timestamp": "2025-11-17T21:33:00Z"
  }
}
```

**Required properties**:
- `export_format`: Format selected by user (pdf, csv, excel)

**Purpose and usage**:
- **Export funnel start**: Track export_requested → export_generated → export_downloaded
- **Format preference**: Which formats are most popular per tier
- **Conversion trigger tracking**: Exports often precede upgrade prompts (Free users hit watermark)

**Analytics queries**:
- Export request rate per calculator
- Format breakdown (example: PDF 60%, CSV 30%, Excel 10%)
- Free tier export requests (potential upgrade candidates)

---

## 6. export_generated

**When fired**: Export file successfully created and ready for download

**Trigger condition**:
- Export generation completes (PDF rendered, CSV assembled, Excel built)
- File saved to storage (S3/R2)
- Before user downloads (this event precedes export_downloaded)

**Required properties**:
```json
{
  "event_name": "export_generated",
  "properties": {
    "session_id": "550e8400-e29b-41d4-a716-446655440000",
    "user_id": null,
    "tier": "free",
    "calculator_slug": "business-loan-dscr",
    "scenario_count": 1,
    "export_format": "pdf",
    "generation_time_ms": 2450,
    "timestamp": "2025-11-17T21:33:03Z"
  }
}
```

**Required properties**:
- `export_format`: Format generated (pdf, csv, excel)
- `generation_time_ms`: Server-side generation latency

**Purpose and usage**:
- **Performance tracking**: Export generation time per format (target: p95 < 3s for PDF)
- **Success rate**: Compare export_requested to export_generated (failure rate = requests - generated / requests)
- **Format-specific performance**: PDF may be slower than CSV

**Analytics queries**:
- p95 generation time per format (example: PDF 2.3s, CSV 0.5s, Excel 1.8s)
- Export generation failure rate (error tracking)

**Error case**: If export fails, fire `export_error` event instead (custom event, not in standard 12) with `error_code` property.

---

## 7. export_downloaded

**When fired**: User clicks download link and file transfer starts

**Trigger condition**:
- User clicks download button or link
- Browser initiates file download (or opens in new tab for PDF preview)

**Required properties**:
```json
{
  "event_name": "export_downloaded",
  "properties": {
    "session_id": "550e8400-e29b-41d4-a716-446655440000",
    "user_id": null,
    "tier": "free",
    "calculator_slug": "business-loan-dscr",
    "export_format": "pdf",
    "timestamp": "2025-11-17T21:33:10Z"
  }
}
```

**Required properties**:
- `export_format`: Format downloaded

**Purpose and usage**:
- **Export completion rate**: Compare export_generated to export_downloaded (did user actually retrieve file?)
- **Drop-off analysis**: If generated but not downloaded, user may have abandoned
- **Tier conversion**: Free users downloading watermarked exports are prime upgrade candidates

**Analytics queries**:
- Export download rate (downloaded / generated)
- Time from export_generated to export_downloaded (how long before user downloads)

**Free tier upgrade trigger**: After Free user downloads watermarked PDF, optionally show upgrade_prompt_shown with `trigger_reason: "watermarked_export"`.

---

## 8. ai_narrative_requested

**When fired**: User requests AI-generated narrative or insight

**Trigger condition**:
- User clicks "Explain this result" button (AI tier feature)
- Or clicks "Get AI suggestions" for scenario ideas
- Before AI API call (request initiated)

**Required properties**:
```json
{
  "event_name": "ai_narrative_requested",
  "properties": {
    "session_id": "550e8400-e29b-41d4-a716-446655440000",
    "user_id": "e8f5a3c2-1234-5678-9abc-def012345678",
    "tier": "ai",
    "calculator_slug": "business-loan-dscr",
    "scenario_count": 2,
    "ai_request_type": "explain_result",
    "timestamp": "2025-11-17T21:34:00Z"
  }
}
```

**Required properties**:
- `ai_request_type`: Type of AI request (explain_result, suggest_scenario, risk_commentary)

**Purpose and usage**:
- **AI feature adoption**: How many AI tier users actually use AI features
- **Request type breakdown**: Which AI features are most popular
- **Cost tracking**: AI requests directly correlate to LLM API costs

**Analytics queries**:
- AI requests per AI tier user per month (usage cap: 50 requests)
- Request type distribution (example: explain_result 70%, suggest_scenario 20%, risk_commentary 10%)
- AI request rate per calculator (which calculators benefit most from AI)

**Free/Pro tier handling**: If non-AI user clicks AI feature, fire `upgrade_prompt_shown` with `trigger_reason: "ai_request"`.

---

## 9. ai_narrative_displayed

**When fired**: AI-generated narrative successfully rendered to user

**Trigger condition**:
- LLM API returns response
- Narrative text rendered in UI (markdown parsed, displayed)
- User sees AI output

**Required properties**:
```json
{
  "event_name": "ai_narrative_displayed",
  "properties": {
    "session_id": "550e8400-e29b-41d4-a716-446655440000",
    "user_id": "e8f5a3c2-1234-5678-9abc-def012345678",
    "tier": "ai",
    "calculator_slug": "business-loan-dscr",
    "scenario_count": 2,
    "ai_request_type": "explain_result",
    "response_time_ms": 2340,
    "timestamp": "2025-11-17T21:34:03Z"
  }
}
```

**Required properties**:
- `ai_request_type`: Type of AI request
- `response_time_ms`: Latency from API call to display (target: p95 < 3s)

**Purpose and usage**:
- **AI success rate**: Compare ai_narrative_requested to ai_narrative_displayed (failure rate = requests - displayed / requests)
- **Performance tracking**: AI response latency per request type
- **Cost-effectiveness**: Successful displays justify AI tier pricing

**Analytics queries**:
- AI success rate (percentage)
- p95 AI response time per request type (example: explain_result 2.1s, suggest_scenario 3.5s)
- AI usage per calculator

**Error case**: If AI fails (timeout, rate limit, API error), fire `ai_error` event (custom) with `error_code`.

---

## 10. upgrade_prompt_shown

**When fired**: Upgrade modal/prompt displays to user

**Trigger condition**:
- Free user hits tier limit (e.g., tries to add second scenario)
- Free user clicks locked feature (e.g., advanced metric)
- Pro user clicks AI feature without AI tier
- Modal renders and is visible

**Required properties**:
```json
{
  "event_name": "upgrade_prompt_shown",
  "properties": {
    "session_id": "550e8400-e29b-41d4-a716-446655440000",
    "user_id": null,
    "tier": "free",
    "calculator_slug": "business-loan-dscr",
    "scenario_count": 1,
    "trigger_reason": "locked_metric",
    "target_tier": "pro",
    "timestamp": "2025-11-17T21:35:30Z"
  }
}
```

**Required properties**:
- `trigger_reason`: Why upgrade prompt shown (add_scenario, locked_metric, clean_export, ai_request)
- `target_tier`: Which tier is being promoted (pro, ai)

**Purpose and usage**:
- **Conversion funnel start**: Track upgrade_prompt_shown → upgrade_prompt_clicked → upgrade_completed
- **Trigger effectiveness**: Which triggers drive highest click-through rates
- **Calculator-specific conversion**: Which calculators drive most upgrade prompts

**Analytics queries**:
- Upgrade prompt impressions per trigger reason
- Prompt-to-click conversion rate (upgrade_prompt_clicked / upgrade_prompt_shown)
- Calculator breakdown (which calculators drive conversions)

**Important**: Do not over-show prompts. Limit to 1 prompt per session per trigger_reason to avoid annoyance.

---

## 11. upgrade_prompt_clicked

**When fired**: User clicks "Upgrade" button in modal

**Trigger condition**:
- User clicks primary CTA button in upgrade modal
- Before redirect to payment page
- Indicates intent to upgrade

**Required properties**:
```json
{
  "event_name": "upgrade_prompt_clicked",
  "properties": {
    "session_id": "550e8400-e29b-41d4-a716-446655440000",
    "user_id": null,
    "tier": "free",
    "calculator_slug": "business-loan-dscr",
    "trigger_reason": "locked_metric",
    "target_tier": "pro",
    "timestamp": "2025-11-17T21:35:45Z"
  }
}
```

**Required properties**:
- `trigger_reason`: Why prompt was shown (matches upgrade_prompt_shown)
- `target_tier`: Which tier upgrade (pro, ai)

**Purpose and usage**:
- **Conversion click-through**: How many impressions result in clicks
- **Trigger ROI**: Which triggers have highest click-through rate
- **Checkout funnel**: Track upgrade_prompt_clicked → upgrade_completed (checkout abandonment)

**Analytics queries**:
- Click-through rate per trigger reason (example: locked_metric 12%, add_scenario 8%)
- Click-to-completion rate (percentage who complete payment after clicking)

**Dismissal tracking**: If user clicks "Not now" instead, optionally fire `upgrade_prompt_dismissed` (custom event) for A/B testing modal messaging.

---

## 12. upgrade_completed

**When fired**: User successfully completes tier upgrade (payment confirmed)

**Trigger condition**:
- Payment processor (Stripe) confirms payment success
- Webhook received: `payment_intent.succeeded`
- User tier updated in database
- User session refreshed with new tier

**Required properties**:
```json
{
  "event_name": "upgrade_completed",
  "properties": {
    "session_id": "550e8400-e29b-41d4-a716-446655440000",
    "user_id": "e8f5a3c2-1234-5678-9abc-def012345678",
    "previous_tier": "free",
    "tier": "pro",
    "target_tier": "pro",
    "calculator_slug": "business-loan-dscr",
    "trigger_reason": "locked_metric",
    "timestamp": "2025-11-17T21:40:23Z"
  }
}
```

**Required properties**:
- `previous_tier`: Tier before upgrade (free, pro)
- `tier`: New tier after upgrade (pro, ai) - same as target_tier
- `target_tier`: Confirm target tier
- `trigger_reason`: Original trigger (matches upgrade_prompt_shown)

**Purpose and usage**:
- **Conversion completion**: Final step in upgrade funnel
- **Revenue attribution**: Which calculators and triggers drive revenue
- **Trigger ROI analysis**: Calculate revenue per trigger reason

**Analytics queries**:
- Conversion rate per trigger reason (upgrade_completed / upgrade_prompt_shown)
- Revenue per calculator (if pricing data available)
- Time from first view to upgrade (days to convert)

**Important**: Fire this event server-side via Stripe webhook, not client-side (prevents missed conversions from page closes).

---

## Event Implementation Checklist

For each calculator, verify all 12 standard events are implemented:

| Event | Implemented | Tested | Analytics Query Verified |
|-------|-------------|--------|--------------------------|
| calculator_viewed | ☑ | ☑ | ☑ |
| calculator_calculated | ☑ | ☑ | ☑ |
| scenario_created | ☑ | ☑ | ☑ |
| scenario_deleted | ☑ | ☑ | ☑ |
| export_requested | ☑ | ☑ | ☑ |
| export_generated | ☑ | ☑ | ☑ |
| export_downloaded | ☑ | ☑ | ☑ |
| ai_narrative_requested | ☑ | ☑ | ☑ |
| ai_narrative_displayed | ☑ | ☑ | ☑ |
| upgrade_prompt_shown | ☑ | ☑ | ☑ |
| upgrade_prompt_clicked | ☑ | ☑ | ☑ |
| upgrade_completed | ☑ | ☑ | ☑ |

**Testing procedure**:
1. Trigger each event in test environment
2. Verify event appears in analytics database with correct properties
3. Confirm no duplicate events (e.g., calculator_viewed should not fire twice on refresh)
4. Test tier gating (Free user gets upgrade_prompt_shown, not scenario_created)

---

## Summary

These 12 standard events provide comprehensive tracking for:
- **Engagement funnels**: Views → Calculations → Exports (conversion at each step)
- **Feature adoption**: Scenario creation, AI usage (Pro/AI tier validation)
- **Conversion funnels**: Upgrade prompt → Click → Completion (revenue attribution)
- **Performance monitoring**: Calculation latency, export generation time, AI response time

All events follow the taxonomy defined in Section 7.1 with consistent naming, required properties, and privacy compliance (pseudonymous IDs only, no PII).
