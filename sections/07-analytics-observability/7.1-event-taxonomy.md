# 7.1 Core Event Taxonomy

This section defines the naming conventions and structure for analytics events across the CFO Business Intelligence Calculator Suite. Consistent event taxonomy enables reliable funnel analysis, conversion tracking, and performance monitoring while maintaining privacy (pseudonymous IDs only, per Section 5.2).

---

## 1. Event Naming Conventions

### Format

**Structure**: `{category}_{action}`

**Rules**:
- Lowercase with underscores (snake_case)
- Category first, action second
- No spaces or special characters
- Concise but descriptive (e.g., `export_downloaded` not `export_file_was_downloaded_by_user`)

**Examples**:
- `calculator_viewed` (Category: calculator, Action: viewed)
- `scenario_created` (Category: scenario, Action: created)
- `export_generated` (Category: export, Action: generated)
- `ai_narrative_requested` (Category: ai, Action: requested)

---

### Allowed Categories

| Category | Description | Example Events |
|----------|-------------|----------------|
| **calculator** | Calculator-level interactions | `calculator_viewed`, `calculator_calculated` |
| **scenario** | Scenario management actions | `scenario_created`, `scenario_updated`, `scenario_deleted` |
| **export** | Export workflow events | `export_requested`, `export_generated`, `export_downloaded` |
| **ai** | AI feature interactions | `ai_narrative_requested`, `ai_narrative_displayed` |
| **upgrade** | Conversion funnel events | `upgrade_prompt_shown`, `upgrade_prompt_clicked`, `upgrade_completed` |
| **user** | User account actions | `user_signup`, `user_login`, `user_logout` |
| **admin** | Admin/support actions | `admin_impersonated`, `admin_config_updated` |

**Why limited categories**: Prevents event sprawl, ensures consistency, simplifies funnel analysis.

---

### Allowed Actions

| Action | Meaning | Example Usage |
|--------|---------|---------------|
| **viewed** | User saw something | `calculator_viewed`, `upgrade_prompt_shown` (passive) |
| **calculated** | Calculation performed | `calculator_calculated` |
| **created** | New entity created | `scenario_created`, `user_signup` |
| **updated** | Entity modified | `scenario_updated` |
| **deleted** | Entity removed | `scenario_deleted` |
| **requested** | User initiated action | `export_requested`, `ai_narrative_requested` |
| **generated** | System produced output | `export_generated`, `ai_narrative_displayed` |
| **downloaded** | User downloaded file | `export_downloaded` |
| **clicked** | User clicked button/link | `upgrade_prompt_clicked` |
| **shown** | UI element displayed | `upgrade_prompt_shown` |
| **completed** | Workflow finished | `upgrade_completed` |

**Why limited actions**: Prevents naming confusion (e.g., "opened" vs "viewed"), ensures funnel consistency.

---

### Naming Examples (Good vs Bad)

| Bad Event Name | Why Bad | Good Event Name |
|----------------|---------|-----------------|
| `CalculatorViewed` | CamelCase (inconsistent) | `calculator_viewed` |
| `calc_view` | Abbreviation unclear | `calculator_viewed` |
| `user-clicked-export` | Hyphens, too verbose | `export_requested` |
| `ai_request` | Ambiguous (request or requested?) | `ai_narrative_requested` |
| `new_scenario` | Action unclear | `scenario_created` |
| `export_file_was_generated` | Too verbose | `export_generated` |

---

## 2. Required Event Properties

**Every event** must include these properties:

### session_id

**Type**: String (UUID v4)
**Description**: Anonymous or authenticated session identifier
**Required**: Yes (always)

**Anonymous users**: Session ID stored in httpOnly cookie, generated on first visit
**Authenticated users**: Session ID regenerated on login (prevents session fixation)

**Example**: `"550e8400-e29b-41d4-a716-446655440000"`

**Privacy**: Session ID is pseudonymous (not reversible to user identity per Section 5.2)

---

### user_id

**Type**: String (UUID v4) or `null`
**Description**: Authenticated user identifier (null for anonymous users)
**Required**: Yes (null allowed)

**Anonymous users**: `user_id: null`
**Authenticated users**: `user_id: "uuid-v4"`

**Example**: `"e8f5a3c2-1234-5678-9abc-def012345678"` or `null`

**Privacy**: User ID is pseudonymous UUID (not email or name per Section 5.2)

---

### tier

**Type**: String (enum)
**Description**: Current user tier
**Required**: Yes (always)

**Allowed values**: `"free"`, `"pro"`, `"ai"`, `"b2b"`

**Example**: `"pro"`

**Purpose**: Segment analytics by tier (Free vs Pro conversion, AI usage by tier)

---

### calculator_slug

**Type**: String (kebab-case)
**Description**: Unique identifier for calculator
**Required**: Yes (always, except user/admin events)

**Examples**: `"business-loan-dscr"`, `"cash-runway"`, `"breakeven-margin"`

**Format**: Lowercase, hyphens, no spaces (matches URL slug)

**Purpose**: Per-calculator analytics (which calculators drive conversions, exports)

---

### scenario_count

**Type**: Integer
**Description**: Number of scenarios active in this calculator session
**Required**: Yes (for calculator events)

**Example**: `1` (Free tier), `3` (Pro tier with multiple scenarios)

**Purpose**: Track multi-scenario usage (Pro feature adoption)

---

### timestamp

**Type**: String (ISO 8601)
**Description**: Event occurrence time in UTC
**Required**: Yes (always)

**Format**: `"YYYY-MM-DDTHH:MM:SSZ"` (UTC timezone, Z suffix)

**Example**: `"2025-11-17T21:30:00Z"`

**Generated**: Server-side (not client-side, prevents clock skew)

---

## 3. Optional Event Properties

Include when relevant to the event context.

### tenant_id

**Type**: String (UUID v4) or `null`
**Description**: B2B tenant identifier (null for individual users)
**Required**: Optional (only for B2B users)

**Example**: `"acme-corp-uuid"` or `null`

**Purpose**: B2B tenant analytics (per-tenant usage, billing)

---

### ab_test_variant

**Type**: String
**Description**: A/B test variant identifier
**Required**: Optional (only when user is in A/B test)

**Examples**: `"new_ui_v2"`, `"simplified_form"`, `"control"`

**Purpose**: A/B test analysis (variant A vs B conversion rates)

---

### referrer

**Type**: String (URL or source identifier)
**Description**: Traffic source
**Required**: Optional (only for entry events like `calculator_viewed`)

**Examples**: `"organic"`, `"google"`, `"paid_search"`, `"affiliate_sba_lender"`, `"direct"`

**Derivation**:
- `document.referrer` (if external domain)
- UTM parameters (`utm_source`, `utm_medium`, `utm_campaign`)
- Direct (no referrer)

**Purpose**: Traffic source analysis (SEO, paid search, affiliates)

---

### export_format

**Type**: String (enum)
**Description**: Export file format
**Required**: Optional (only for export events)

**Allowed values**: `"pdf"`, `"csv"`, `"excel"`

**Example**: `"pdf"`

**Purpose**: Export format preference analysis

---

### ai_request_type

**Type**: String (enum)
**Description**: Type of AI request
**Required**: Optional (only for AI events)

**Allowed values**: `"explain_result"`, `"suggest_scenario"`, `"risk_commentary"`

**Example**: `"explain_result"`

**Purpose**: AI feature usage breakdown (which AI features are popular)

---

### error_code

**Type**: String
**Description**: Error code for failed events
**Required**: Optional (only for error events)

**Examples**: `"calculation_timeout"`, `"export_generation_failed"`, `"ai_api_rate_limit"`

**Purpose**: Error categorization and debugging

---

### generation_time_ms

**Type**: Integer (milliseconds)
**Description**: Time taken to generate output
**Required**: Optional (only for generation events like `export_generated`, `ai_narrative_displayed`)

**Example**: `2450` (2.45 seconds)

**Purpose**: Performance tracking (per Section 1.6 SLAs)

---

### response_time_ms

**Type**: Integer (milliseconds)
**Description**: Time taken for response (server-side)
**Required**: Optional (only for response events)

**Example**: `142` (142 milliseconds)

**Purpose**: Performance tracking (calculation latency, API response time)

---

### trigger_reason

**Type**: String
**Description**: Why upgrade prompt was shown
**Required**: Optional (only for upgrade events)

**Examples**: `"add_scenario"`, `"locked_metric"`, `"clean_export"`, `"ai_request"`

**Purpose**: Conversion trigger analysis (which prompts drive conversions)

---

### target_tier

**Type**: String (enum)
**Description**: Tier being upgraded to
**Required**: Optional (only for upgrade click/completion events)

**Allowed values**: `"pro"`, `"ai"`

**Example**: `"pro"`

**Purpose**: Conversion funnel (Free → Pro vs Pro → AI)

---

### previous_tier

**Type**: String (enum)
**Description**: Tier before upgrade
**Required**: Optional (only for upgrade completion events)

**Allowed values**: `"free"`, `"pro"`

**Example**: `"free"`

**Purpose**: Conversion cohort analysis (Free → Pro conversion rate)

---

## Event Payload Structure

### Example: calculator_viewed

```json
{
  "event_name": "calculator_viewed",
  "properties": {
    "session_id": "550e8400-e29b-41d4-a716-446655440000",
    "user_id": null,
    "tier": "free",
    "calculator_slug": "business-loan-dscr",
    "scenario_count": 0,
    "timestamp": "2025-11-17T21:30:00Z",
    "referrer": "google",
    "ab_test_variant": "new_ui_v2"
  }
}
```

---

### Example: export_generated

```json
{
  "event_name": "export_generated",
  "properties": {
    "session_id": "550e8400-e29b-41d4-a716-446655440000",
    "user_id": "e8f5a3c2-1234-5678-9abc-def012345678",
    "tier": "pro",
    "calculator_slug": "business-loan-dscr",
    "scenario_count": 3,
    "timestamp": "2025-11-17T21:35:12Z",
    "export_format": "pdf",
    "generation_time_ms": 2450
  }
}
```

---

### Example: ai_narrative_displayed

```json
{
  "event_name": "ai_narrative_displayed",
  "properties": {
    "session_id": "550e8400-e29b-41d4-a716-446655440000",
    "user_id": "e8f5a3c2-1234-5678-9abc-def012345678",
    "tier": "ai",
    "calculator_slug": "business-loan-dscr",
    "scenario_count": 2,
    "timestamp": "2025-11-17T21:32:45Z",
    "ai_request_type": "explain_result",
    "response_time_ms": 2340
  }
}
```

---

### Example: upgrade_completed

```json
{
  "event_name": "upgrade_completed",
  "properties": {
    "session_id": "550e8400-e29b-41d4-a716-446655440000",
    "user_id": "e8f5a3c2-1234-5678-9abc-def012345678",
    "tier": "pro",
    "calculator_slug": "business-loan-dscr",
    "scenario_count": 1,
    "timestamp": "2025-11-17T21:40:23Z",
    "previous_tier": "free",
    "target_tier": "pro",
    "trigger_reason": "locked_metric"
  }
}
```

---

### Example: calculation error event

```json
{
  "event_name": "calculator_error",
  "properties": {
    "session_id": "550e8400-e29b-41d4-a716-446655440000",
    "user_id": null,
    "tier": "free",
    "calculator_slug": "business-loan-dscr",
    "scenario_count": 1,
    "timestamp": "2025-11-17T21:33:15Z",
    "error_code": "calculation_timeout",
    "error_message": "Calculation exceeded 10-second timeout"
  }
}
```

---

## Event Validation

### Server-Side Validation

**Before logging event**:
1. Validate event name matches taxonomy (`{category}_{action}`)
2. Validate required properties present (session_id, tier, timestamp, etc.)
3. Validate property types (session_id is UUID, tier is enum, timestamp is ISO 8601)
4. Validate property values (tier in ["free", "pro", "ai", "b2b"])

**Reject invalid events**: Return 400 Bad Request if validation fails

**Example validation code**:
```typescript
function validateEvent(event: AnalyticsEvent): ValidationResult {
  const errors: string[] = [];

  // Validate event name format
  if (!event.event_name.match(/^[a-z]+_[a-z]+$/)) {
    errors.push('Event name must match format: {category}_{action}');
  }

  // Validate required properties
  const required = ['session_id', 'user_id', 'tier', 'timestamp'];
  for (const prop of required) {
    if (event.properties[prop] === undefined) {
      errors.push(`Missing required property: ${prop}`);
    }
  }

  // Validate tier enum
  const validTiers = ['free', 'pro', 'ai', 'b2b'];
  if (!validTiers.includes(event.properties.tier)) {
    errors.push(`Invalid tier: ${event.properties.tier}`);
  }

  // Validate timestamp format (ISO 8601)
  if (!event.properties.timestamp.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}Z$/)) {
    errors.push('Timestamp must be ISO 8601 format (UTC)');
  }

  return { valid: errors.length === 0, errors };
}
```

---

## Event Storage

**Database schema** (PostgreSQL):
```sql
CREATE TABLE analytics_events (
  event_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  event_name VARCHAR(255) NOT NULL,
  session_id UUID NOT NULL,
  user_id UUID,
  tier VARCHAR(50) NOT NULL,
  calculator_slug VARCHAR(255),
  properties JSONB NOT NULL,
  timestamp TIMESTAMPTZ NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_events_session_id ON analytics_events(session_id);
CREATE INDEX idx_events_user_id ON analytics_events(user_id);
CREATE INDEX idx_events_event_name ON analytics_events(event_name);
CREATE INDEX idx_events_timestamp ON analytics_events(timestamp);
CREATE INDEX idx_events_calculator_slug ON analytics_events(calculator_slug);
```

**Partitioning** (for performance):
- Partition by month: `events_2025_01`, `events_2025_02`, etc.
- Drop old partitions after 12 months (per Section 5.4 retention policy)

---

## Privacy Compliance

**PII exclusion** (per Section 5.2):
- ✗ Never log: Email addresses, names, IP addresses (except hashed), credit card numbers
- ✓ Pseudonymous IDs only: session_id (UUID), user_id (UUID)
- ✓ Aggregated data: Tier, calculator slug, referrer (no individual identifiers)

**IP address handling**:
- Hash IP before logging: `sha256(ip_address + secret_salt)`
- Use hashed IP only for abuse detection (rate limiting, bot detection)
- Do not log raw IP addresses in analytics events

**User consent**:
- Telemetry opt-out available (per Section 5.4)
- B2B tenants can disable telemetry entirely (`telemetry_enabled: false`)

---

## Summary

This event taxonomy provides:
- **Consistent naming**: `{category}_{action}` format (e.g., `calculator_viewed`, `export_downloaded`)
- **Required properties**: session_id, user_id, tier, calculator_slug, scenario_count, timestamp
- **Optional properties**: tenant_id, ab_test_variant, referrer, export_format, ai_request_type, error_code
- **Privacy compliance**: Pseudonymous IDs only, no PII in event logs
- **Validation**: Server-side validation of event names and property types

All events follow this taxonomy for reliable funnel analysis, conversion tracking, and performance monitoring.
