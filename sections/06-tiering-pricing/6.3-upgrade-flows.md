# 6.3 Upgrade Flows (Global)

This section defines the upgrade triggers, modal design, payment integration, and post-upgrade experience for the CFO Business Intelligence Calculator Suite. Clear, frictionless upgrade flows maximize Free â†’ Pro and Pro â†’ AI conversion rates while maintaining a non-pushy, professional tone.

---

## 1. Upgrade Triggers

Upgrade prompts appear when users attempt to access tier-gated features. Triggers must be contextual (relevant to user's current task) and non-blocking (allow user to continue with Free tier if desired).

### Free â†’ Pro Triggers

**Trigger 1: Click "Add Scenario" Button**

**Context**: User has created one scenario and wants to compare alternatives side-by-side.

**User action**: Clicks "+ Add Scenario" button in scenario tabs

**System response**:
1. Check user tier: `if (userTier === 'free')` â†’ show upgrade modal
2. Modal headline: "Compare Multiple Scenarios with Pro"
3. Modal features list:
   - Save up to 50 scenarios per calculator
   - Compare scenarios side-by-side with delta indicators
   - Version history and audit trail
   - Clean exports without watermarks
4. CTA button: "Start Free Trial" (14 days, no credit card)
5. Dismiss link: "Not now" (closes modal, user continues with single scenario)

**Frequency limit**: Show modal max 3 times per session (track in sessionStorage)

---

**Trigger 2: Click Locked Advanced Metric**

**Context**: User sees DSCR, NPV/IRR, or other advanced metric blurred with lock icon.

**User action**: Clicks blurred metric or "ğŸ”’ Unlock Pro" button

**System response**:
1. Modal headline: "Unlock CFO-Grade Metrics with Pro"
2. Modal features list:
   - DSCR and debt service coverage analysis
   - NPV/IRR for capital investment decisions
   - Covenant headroom and threshold warnings
   - Contribution margin and margin of safety
3. Visual: Screenshot or animated GIF showing unlocked metrics
4. CTA button: "Upgrade to Pro - $29/month"
5. Secondary CTA: "Start 14-Day Free Trial"

**Messaging emphasis**: "Get the insights lenders and boards expect"

---

**Trigger 3: Request Clean Export**

**Context**: User generates export and sees watermark in PDF or header row in CSV.

**User action**: Sees "Watermark-free exports available with Pro" banner, clicks "Upgrade"

**System response**:
1. Modal headline: "Create Board-Ready Reports with Pro"
2. Modal features list:
   - Clean PDFs without watermarks or ads
   - Professional CSV exports for lenders
   - Multi-tab Excel exports (formulas preserved)
   - Version stamps and audit trail metadata
3. Visual: Side-by-side comparison (Free watermarked export vs Pro clean export)
4. CTA button: "Upgrade to Pro"

**Alternative flow**: Inline banner in export confirmation page
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Your export is ready (Free tier - watermarked)            â”‚
â”‚ [ Download PDF ]                                           â”‚
â”‚                                                            â”‚
â”‚ Want clean exports? Upgrade to Pro for board-ready PDFs.  â”‚
â”‚ [ Upgrade to Pro â†’ ]                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Trigger 4: Attempting to Share Scenario**

**Context**: User wants to share scenario with colleague, lender, or board member.

**User action**: Clicks "Share" button (visible but disabled in Free tier)

**System response**:
1. Modal headline: "Share Scenarios with Pro"
2. Modal features list:
   - Generate shareable links (view-only or edit permissions)
   - Share outputs without exposing inputs (privacy for lenders)
   - Prepared by/reviewed by metadata for audit trail
3. CTA button: "Start Free Trial"

---

### Pro/Free â†’ AI Add-On Triggers

**Trigger 1: Click "âœ¨ AI Explanation" Button**

**Context**: User wants plain-English explanation of calculation results.

**User action**: Clicks "âœ¨ AI Explanation" button in results panel

**System response**:
1. Modal headline: "Unlock AI Insights with AI Add-On"
2. Modal features list:
   - Plain-English explanations of your results
   - Risk commentary and actionable suggestions
   - Scenario recommendations ("Consider extending loan term to improve DSCR")
   - 50 AI requests per month
3. Visual: Example AI narrative (truncated, "Unlock to see full explanation")
4. CTA button: "Add AI - $20/month" (if already Pro) or "Upgrade to Pro + AI - $49/month" (if Free)

**Messaging emphasis**: "Understand your results like a CFO"

---

**Trigger 2: See "AI Suggestions" Teaser**

**Context**: Results panel shows teaser for AI-powered scenario suggestions.

**User action**: Clicks "Get AI Suggestions" teaser card

**System response**:
1. Modal headline: "AI-Powered Scenario Suggestions"
2. Modal description: "Get AI recommendations for optimizing your scenario. Example: 'Extending your loan term from 5 to 7 years would reduce monthly payment by $800 and improve DSCR to 1.45.'"
3. CTA button: "Add AI Add-On"

---

## 2. Upgrade Modal Design

### Modal Structure

**Wireframe**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [X] Close                                                  â”‚
â”‚                                                            â”‚
â”‚  ğŸ”’ Unlock [Feature] with [Tier]                          â”‚
â”‚                                                            â”‚
â”‚  [Icon or screenshot of feature]                           â”‚
â”‚                                                            â”‚
â”‚  With [Tier], you get:                                     â”‚
â”‚  âœ“ [Benefit 1]                                             â”‚
â”‚  âœ“ [Benefit 2]                                             â”‚
â”‚  âœ“ [Benefit 3]                                             â”‚
â”‚  âœ“ [Benefit 4]                                             â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Monthly: $29/month                                  â”‚ â”‚
â”‚  â”‚  Annual: $290/year (save $58 - 17% off)             â”‚ â”‚
â”‚  â”‚  â— Monthly  â—‹ Annual                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                            â”‚
â”‚  [ Start 14-Day Free Trial ]  (no credit card required)   â”‚
â”‚  or                                                        â”‚
â”‚  [ Upgrade Now - $29/month ]                               â”‚
â”‚                                                            â”‚
â”‚  Not now (closes modal)                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key elements**:
1. **Close button** (top-right X): Non-aggressive (user can dismiss anytime)
2. **Headline**: Clear value proposition (not "Upgrade to Pro" but "Unlock [Feature] with Pro")
3. **Visual**: Screenshot or icon showing locked feature
4. **Benefits list**: 3-5 bullet points (focus on outcomes, not features)
5. **Pricing toggle**: Monthly vs Annual (default: Annual to maximize LTV)
6. **Primary CTA**: "Start Free Trial" (removes barrier)
7. **Secondary CTA**: "Upgrade Now" (for users who know they want Pro)
8. **Dismiss link**: "Not now" (subtle, bottom of modal)

---

### Messaging Per Trigger

**Second scenario trigger**:
```
Headline: Compare Multiple Scenarios with Pro

Benefits:
âœ“ Save up to 50 scenarios per calculator
âœ“ Compare scenarios side-by-side with charts
âœ“ Track changes with version history
âœ“ Share scenarios with colleagues and advisors

Pricing: $29/month or $290/year (save 17%)

CTA: Start 14-Day Free Trial
```

---

**Advanced metrics trigger**:
```
Headline: Unlock CFO-Grade Metrics with Pro

Benefits:
âœ“ DSCR (Debt Service Coverage Ratio) analysis
âœ“ NPV/IRR for capital investment decisions
âœ“ Covenant headroom and risk warnings
âœ“ Contribution margin and profitability metrics

Pricing: $29/month or $290/year (save 17%)

CTA: Start 14-Day Free Trial
```

---

**Clean export trigger**:
```
Headline: Create Board-Ready Reports with Pro

Benefits:
âœ“ Clean PDFs without watermarks or ads
âœ“ Banker-friendly CSVs for lender presentations
âœ“ Multi-tab Excel exports with formulas
âœ“ Professional version stamps and audit trail

Pricing: $29/month or $290/year (save 17%)

CTA: Start 14-Day Free Trial
```

---

**AI trigger**:
```
Headline: Unlock AI Insights with AI Add-On

Benefits:
âœ“ Plain-English explanations of your results
âœ“ Risk commentary and actionable suggestions
âœ“ Scenario recommendations from AI
âœ“ 50 AI requests per month

Pricing: +$20/month (total $49/month with Pro)

CTA: Add AI Add-On
```

---

### Modal Behavior

**Frequency limits**:
- Max 3 upgrade modals per session (track in sessionStorage)
- After 3rd dismiss, show inline banner only (no modal)
- Reset on new session (user returns next day)

**Dismiss behavior**:
- Clicking "Not now" closes modal (no penalty, user continues with Free tier)
- Clicking [X] close button same as "Not now"
- Clicking outside modal closes modal (optional, test with users)

**Persistence** (optional Phase 2 feature):
- Track which triggers user dismissed (e.g., "User dismissed 'add scenario' modal 3 times")
- Show different trigger next time (e.g., switch to 'clean export' trigger)

---

## 3. Payment Integration

### Payment Processor: Stripe

**Why Stripe**:
- Industry standard for SaaS subscriptions
- Excellent developer experience (Stripe Checkout, Stripe Billing)
- Built-in support for trials, upgrades, downgrades, proration
- PCI compliance handled by Stripe (no card data touches our servers)

### Checkout Flow

**Option A: In-App Modal with Stripe Checkout Embed** (preferred for Phase 1)

1. User clicks "Start Free Trial" or "Upgrade Now"
2. Modal expands to show Stripe Checkout iframe:
   ```
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Start Your 14-Day Free Trial         â”‚
   â”‚                                        â”‚
   â”‚  [Stripe Checkout iframe]              â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
   â”‚  â”‚ Email: ________________          â”‚  â”‚
   â”‚  â”‚ Card: ____ ____ ____ ____        â”‚  â”‚
   â”‚  â”‚ Exp: __ / __ CVV: ___            â”‚  â”‚
   â”‚  â”‚                                  â”‚  â”‚
   â”‚  â”‚ [ Start Trial ]                  â”‚  â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
   â”‚                                        â”‚
   â”‚  No charge today. Cancel anytime.      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   ```
3. User enters payment details (card stored by Stripe, not by us)
4. Stripe validates card â†’ returns success or error
5. On success: Close modal, activate Pro immediately (see Post-Upgrade Experience)

**Advantages**: User stays on our site (better conversion), seamless UX
**Disadvantages**: Requires Stripe Checkout JS SDK, slightly more complex implementation

---

**Option B: Redirect to Hosted Stripe Page** (fallback)

1. User clicks "Start Free Trial" or "Upgrade Now"
2. Redirect to Stripe-hosted checkout page (leaves our site)
3. User enters payment details on Stripe page
4. On success: Stripe redirects back to our site with success token
5. Our server activates Pro tier, shows success message

**Advantages**: Simpler implementation, fully hosted by Stripe
**Disadvantages**: User leaves our site (lower conversion), less control over UX

**Phase 1 recommendation**: Option A (in-app modal) for best conversion rates.

---

### Subscription Management

**Upgrade (Free â†’ Pro, Pro â†’ AI)**:
- **Immediate activation**: User gets Pro features instantly
- **Proration**: If upgrading mid-month, charge prorated amount for remaining days
- **Trial handling**: 14-day free trial (no charge until trial ends)

**Downgrade (Pro â†’ Free, AI â†’ Pro)**:
- **End-of-period**: Downgrade takes effect at end of current billing period (no refund)
- **Grace period**: User retains Pro features until billing period ends
- **Data retention**: Scenarios retained for 30 days (user can export before downgrade)

**Cancel**:
- **End-of-period**: Cancellation takes effect at end of current billing period (no refund)
- **Retention offer** (optional Phase 2): "Are you sure? Stay on Pro for 50% off next 3 months"

**Example flow**:
```
User on Pro ($29/month, renews on 1st of month)
  â†“
User clicks "Cancel" on Jan 15
  â†“
System confirms: "Your Pro subscription will end on Feb 1. You can continue using Pro until then."
  â†“
Feb 1: Downgrade to Free, retain scenarios for 30 days
```

---

### Webhook Handling

Stripe sends webhooks for subscription events. Our server listens and responds.

**Key webhooks**:

**1. `payment_intent.succeeded`**
- Triggered when: User's payment succeeds (trial ends, monthly renewal)
- Action: Activate or maintain Pro tier, send receipt email

```typescript
async function handlePaymentSucceeded(event) {
  const paymentIntent = event.data.object;
  const customerId = paymentIntent.customer;

  // Find user by Stripe customer ID
  const user = await getUserByStripeCustomerId(customerId);

  // Activate Pro tier
  await updateUserTier(user.id, 'pro');

  // Send receipt email
  await sendEmail(user.email, 'receipt', { amount: paymentIntent.amount });
}
```

---

**2. `payment_intent.payment_failed`**
- Triggered when: Payment fails (expired card, insufficient funds)
- Action: Notify user, show retry message, pause tier (grace period)

```typescript
async function handlePaymentFailed(event) {
  const paymentIntent = event.data.object;
  const user = await getUserByStripeCustomerId(paymentIntent.customer);

  // Send email: "Payment failed. Update payment method to continue Pro."
  await sendEmail(user.email, 'payment_failed');

  // Grace period: Allow 7 days to update payment method
  await setTierGracePeriod(user.id, 7);
}
```

---

**3. `customer.subscription.deleted`**
- Triggered when: Subscription canceled or payment failed repeatedly
- Action: Downgrade to Free tier

```typescript
async function handleSubscriptionDeleted(event) {
  const subscription = event.data.object;
  const user = await getUserByStripeCustomerId(subscription.customer);

  // Downgrade to Free
  await updateUserTier(user.id, 'free');

  // Send email: "Your Pro subscription has ended. Scenarios retained for 30 days."
  await sendEmail(user.email, 'subscription_ended');
}
```

---

**4. `customer.subscription.updated`**
- Triggered when: User upgrades (Pro â†’ AI) or changes plan (monthly â†’ annual)
- Action: Update user tier, prorate charges

```typescript
async function handleSubscriptionUpdated(event) {
  const subscription = event.data.object;
  const user = await getUserByStripeCustomerId(subscription.customer);

  // Detect tier change (check subscription items)
  const hasAI = subscription.items.data.some(item => item.price.product === 'ai_addon');
  const newTier = hasAI ? 'ai' : 'pro';

  await updateUserTier(user.id, newTier);
}
```

---

**Webhook security**:
- Verify webhook signature (Stripe sends `Stripe-Signature` header)
- Reject unsigned or invalid webhooks (prevents spoofing)

```typescript
app.post('/webhooks/stripe', async (req, res) => {
  const sig = req.headers['stripe-signature'];
  const webhookSecret = process.env.STRIPE_WEBHOOK_SECRET;

  let event;
  try {
    event = stripe.webhooks.constructEvent(req.body, sig, webhookSecret);
  } catch (err) {
    return res.status(400).send(`Webhook Error: ${err.message}`);
  }

  // Handle event
  switch (event.type) {
    case 'payment_intent.succeeded':
      await handlePaymentSucceeded(event);
      break;
    // ... other handlers
  }

  res.json({ received: true });
});
```

---

## 4. Post-Upgrade Experience

### Immediate Unlocking

**After successful payment** (or trial start):

1. **Close checkout modal** (or redirect back from Stripe)
2. **Refresh tier status** (API call: `GET /api/user/tier` â†’ returns `{tier: 'pro'}`)
3. **Show success message** (toast notification or inline banner):
   ```
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ âœ“ You're now on Pro!                   â”‚
   â”‚ All features unlocked. Enjoy!          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   ```
4. **Unlock all gated features immediately**:
   - Advanced metrics visible (no blur, no lock icons)
   - "Add Scenario" button enabled (no upgrade prompt)
   - Export options show "Clean" instead of "Watermarked"
   - Ads removed (no banner ads or affiliate links)

**No page refresh required**: Update React state (`userTier` prop) â†’ components re-render with unlocked features.

---

### Onboarding (Optional Phase 2 Feature)

**Tooltip tour**: Guide user through new features.

```
Step 1: Point to "Add Scenario" button
"Now you can create multiple scenarios and compare side-by-side."
[ Next ]

Step 2: Point to DSCR metric
"CFO-grade metrics like DSCR are now unlocked."
[ Next ]

Step 3: Point to Export button
"Your exports are now watermark-free and board-ready."
[ Done ]
```

**Dismissible**: User can skip tour (show "Skip" button on each step)
**Shown once**: Track `onboarding_completed` flag in user profile

---

### Email Confirmation

**Subject**: "Welcome to Pro! Here's What You Get"

**Body**:
```
Hi [User Name],

Welcome to Pro! You now have access to:

âœ“ Up to 50 scenarios per calculator
âœ“ CFO-grade metrics (DSCR, NPV/IRR, covenant headroom)
âœ“ Clean, board-ready exports
âœ“ Scenario sharing and collaboration

Your subscription:
- Plan: Pro (Monthly)
- Price: $29/month
- Next billing date: Feb 15, 2025

Manage your subscription: [Link to account settings]

Questions? Reply to this email or visit our help center.

Cheers,
The [Product Name] Team
```

**Attachments**: PDF receipt (Stripe generates automatically)

**Timing**: Send immediately after successful payment (via webhook handler)

---

### Trial-Specific Experience

**During 14-day trial**:
- User has full Pro access (no limitations)
- Email reminders:
  - Day 7: "You have 7 days left in your Pro trial. Loving it? Your subscription starts on [Date]."
  - Day 13: "Your Pro trial ends tomorrow. Your card will be charged $29 on [Date]. Cancel anytime."
- In-app banner: "Trial ends in X days. [Manage subscription]"

**Trial end**:
- Day 14: Charge card $29 â†’ convert to paid Pro
- If payment fails: Send "Payment failed" email, 7-day grace period (retain Pro features)
- If user cancels before trial ends: No charge, downgrade to Free on day 14

**Trial cancellation flow**:
```
User clicks "Cancel Trial" in account settings
  â†“
Confirmation modal: "Cancel your Pro trial? You'll lose access to Pro features on [Date]."
  [ Keep Trial ]  [ Cancel Trial ]
  â†“
If "Cancel Trial": Mark subscription as canceled (Stripe)
  â†“
Day 14: Downgrade to Free (no charge)
```

---

## Upgrade Flow Diagram

**Free â†’ Pro (Trial)**:
```
User clicks upgrade trigger
  â†“
Upgrade modal appears
  â†“
User clicks "Start 14-Day Free Trial"
  â†“
Stripe Checkout modal appears
  â†“
User enters card details
  â†“
Stripe validates card (no charge)
  â†“
Success â†’ Close modal, activate Pro immediately
  â†“
Show success message: "You're now on Pro! Trial ends on [Date]."
  â†“
Unlock all Pro features (scenarios, metrics, exports)
  â†“
Send welcome email with trial details
  â†“
Day 14: Charge card $29, convert to paid Pro
```

---

**Pro â†’ AI Add-On**:
```
User clicks "âœ¨ AI Explanation" button
  â†“
Upgrade modal appears: "Add AI for $20/month"
  â†“
User clicks "Add AI Add-On"
  â†“
Stripe updates subscription (add AI item)
  â†“
Prorate charge: $20 Ã— (days remaining / 30)
  â†“
Success â†’ Close modal, activate AI immediately
  â†“
Show success message: "AI add-on activated! You have 50 AI requests this month."
  â†“
Unlock AI features (narratives, suggestions)
  â†“
Send email: "AI add-on added. New total: $49/month."
```

---

## Summary

This upgrade flow strategy ensures:
- **Contextual triggers**: Upgrade prompts appear when users need locked features (not random popups)
- **Non-aggressive UX**: Max 3 modals per session, easy dismiss, no dark patterns
- **Clear value**: Benefits-focused messaging (not just "Upgrade to Pro")
- **Frictionless payment**: Stripe Checkout embed, 14-day trial, no credit card for trial
- **Immediate activation**: Pro features unlock instantly after payment (no waiting)
- **Post-upgrade delight**: Success message, onboarding tour (optional), welcome email

All upgrade flows tested for conversion optimization (A/B test messaging, CTA placement, pricing toggle) and implemented with clean UX (no pushy tactics, respect user's choice to stay Free).
